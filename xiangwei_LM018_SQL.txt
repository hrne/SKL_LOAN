WITH "OutputMonths" AS (

SELECT UNIQUE "YearMonth"
              ,CASE WHEN "Fn_GetWorkSeason"("YearMonth", 3) > :entYearMonth
                    THEN TO_NUMBER(:entYearMonth)
               ELSE "Fn_GetWorkSeason"("YearMonth", 3) END "VisibleMonth"
FROM "MonthlyLoanBal"
WHERE "YearMonth" BETWEEN TO_NUMBER(:entYear) * 100 + 1 AND :entYearMonth
),

"SubjectProdNo" AS (
SELECT 'IA' AS "ProdNo" 
      ,'IA' AS "ProdNoShow"
FROM DUAL
UNION ALL
SELECT 'IB' AS "ProdNo" 
      ,'IB' AS "ProdNoShow"
FROM DUAL
UNION ALL
SELECT 'IC' AS "ProdNo" 
      ,'IC' AS "ProdNoShow"
FROM DUAL
UNION ALL
SELECT 'ID' AS "ProdNo" 
      ,'ID' AS "ProdNoShow"
FROM DUAL
UNION ALL
SELECT 'IE' AS "ProdNo" 
      ,'ID' AS "ProdNoShow"
FROM DUAL
UNION ALL
SELECT 'IF' AS "ProdNo" 
      ,'IF' AS "ProdNoShow"
FROM DUAL
UNION ALL
SELECT 'IG' AS "ProdNo" 
      ,'IF' AS "ProdNoShow"
FROM DUAL
UNION ALL
SELECT 'IH' AS "ProdNo" 
      ,'IH' AS "ProdNoShow"
FROM DUAL
UNION ALL
SELECT 'II' AS "ProdNo" 
      ,'IH' AS "ProdNoShow"
FROM DUAL
UNION ALL
SELECT '81' AS "ProdNo" 
      ,'ZZ' AS "ProdNoShow"
FROM DUAL
UNION ALL
SELECT '82' AS "ProdNo" 
      ,'ZZ' AS "ProdNoShow"
FROM DUAL
UNION ALL
SELECT '83' AS "ProdNo" 
      ,'ZZ' AS "ProdNoShow"
FROM DUAL
UNION ALL
SELECT '340' AS "ProdNo"
      ,'AA' AS "ProdNoShow"
FROM DUAL
)

SELECT om."VisibleMonth"
      ,int."ProdNoShow"
      ,SUM(bal."BalSum")
      ,SUM(int."IntSum")
FROM "OutputMonths" om 
LEFT JOIN (SELECT spn."ProdNoShow"
                 ,om."YearMonth"
                 ,SUM(DECODE(ad."DbCr", 'C', ad."TxAmt", -ad."TxAmt")) "IntSum"
           FROM "AcDetail" ad
           LEFT JOIN "FacMain" fm ON fm."CustNo" = ad."CustNo"
                                 AND fm."FacmNo" = ad."FacmNo"
           LEFT JOIN "SubjectProdNo" spn ON (spn."ProdNo" = fm."ProdNo" OR spn."ProdNo" = fm."AcctCode")
                                        AND fm."AcctCode" IN (310,320,330,340)
           LEFT JOIN "OutputMonths" om ON om."YearMonth" = FLOOR(ad."RelDy"/100)
           WHERE ad."RelDy" BETWEEN :entYear||'0101' AND :entYear||'1231'
           AND spn."ProdNo" is not null
           AND ad."AcctCode" IN ('IC1','IC2','IC3','IC4','IOP','IOV')
           GROUP BY spn."ProdNoShow"
                   ,om."YearMonth"
          ) int ON int."VisibleMonth" = om."YearMonth"
LEFT JOIN (SELECT spn."ProdNoShow"
                 ,om."YearMonth"
                 ,SUM(mlb."LoanBalance") "BalSum"
           FROM "MonthlyLoanBal" mlb
           LEFT JOIN "SubjectProdNo" spn ON (spn."ProdNo" = mlb."ProdNo" OR spn."ProdNo" = mlb."AcctCode")
                                        AND mlb."AcctCode" IN (310,320,330,340)
           LEFT JOIN "OutputMonths" om ON om."YearMonth" = mlb."YearMonth"
           WHERE mlb."YearMonth" BETWEEN :entYear * 100 AND :entYearMonth
           AND spn."ProdNo" is not null
           GROUP BY spn."ProdNoShow"
                   ,om."YearMonth"
          ) bal ON bal."YearMonth" = om."YearMonth"
               AND om."YearMonth" = om."VisibleMonth"
               AND bal."ProdNoShow" = int."ProdNoShow"
WHERE int."ProdNoShow" is not null
GROUP BY om."VisibleMonth"
        ,int."ProdNoShow"
ORDER BY om."VisibleMonth"
        ,int."ProdNoShow"
;