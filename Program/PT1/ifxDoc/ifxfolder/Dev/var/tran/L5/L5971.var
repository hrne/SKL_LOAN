!---------- BASIC LABEL Variables ----------
<sub type="SYS">
</sub>

<sub type="SYS" name="label">
!#TXCD
!T(3,L5971)

![資料表頭(HEADER)長度]
#INQHD=n,3,S
E(0,100)ASGN(INQHD$)

![每筆資料明細(OCCURS)長度]
#INQLEN=n,3,S
E(0,109)ASGN(INQLEN$)

![多筆查詢之一個畫面有N筆資料]
#INQREC=n,2,S
E(0,40)ASGN(INQREC$)

![畫面顯示的明細間的高度]
#LOOPH=n,3,S
E(0,1)ASGN(LOOPHEIGHT$)

![每張印錄單列印的筆數]
#INQPRT=n,2,S
E(0,40)ASGN(INQPRT$)

#button=x,1,S
K(MODIFYBUTTON,查詢)

</sub>

<sub type="DC" name="BFHEAD">
<include src="COM.icf::BFHEAD.dec"/>
!起始交易記號  0:起始交易,1:非起始交易
#ORGFG=_,_,S
E(0,0)
</sub>

!---------- 交易畫面及個別交易變數宣告 ----------
<sub type="DC" name="L5971" layout="cols=1;screen.width=[130,870];printer.width=[20,80];order=1">
[
["[L5971]                                 債務協商交易資料查詢"],
["#FdCustId+身分證字號",#CustId],
["#FdCaseSeq+案件序號",#CaseSeq],
["#FdEntryDateStart+入帳日期",#EntryDateStart,"~",#EntryDateEnd],
]

#FdCustId=X,2,L
T(3,*)
#FdCaseSeq=X,2,L
T(3,*)
#FdEntryDateStart=X,2,L


#CHAIN=A,1,S
T(4,CHAIN$)

<include src="HELPRIM.icf::HELPRIM.rtn"/>
! TxKind
#TxKindCode=x,20,S
T(3,CdCode.NegTxKind)
#TxKindHelp=x,1024,S

! Status
#StatusCode=x,20,S
T(3,CdCode.NegStatus)
#StatusHelp=x,1024,S

! CustLoanKind
#CustLoanKindCode=x,20,S
T(3,CdCode.CustLoanKind)
#CustLoanKindHelp=x,1024,S

! CaseKindCode
#CaseKindCodeCode=x,20,S
T(3,CdCode.CaseKindCode)
#CaseKindCodeHelp=x,1024,S


#TxKindHelpRim=X,1,S
RESET_RIM(#TxKindHelpRim,XXR99)
S(XXR99,01,#TxKindCode,#StatusCode,#CustLoanKindCode,#CaseKindCodeCode)
R(1,XXR99)
CALL(#HelpProc)
T(2,@TxKindHelp,#HelpDesc1)
T(2,@StatusHelp,#HelpDesc2)
T(2,@CustLoanKindHelp,#HelpDesc3)
T(2,@CaseKindCodeHelp,#HelpDesc4)


! 功能代碼
#FunctionCode=X,2,S

! 連動查詢 L5071,L5701
#ChainSearch=X,22,S
IF(#CHAIN==1,$,S)
C(3,#CHAIN,1,T(4,NTXBUF$),S)
T(1,@FunctionCode,#ChainSearch,1,2)
IF(#FunctionCode=="05",$,S)
T(1,@CustId,#ChainSearch,3,10)
! T(1,@CustNo,#ChainSearch,13,7)
T(1,@CaseSeq,#ChainSearch,20,3)
INVOKEJS(SHOW,p1,03,03,0)

! 身分證號
#CustId=X,10,I
IF(#CHAIN==0,$,s)
@V(7)
@C(4,#CustId,S,$)
A(ID_UNINO,0,#CustId)

!身分證找戶號
<include src="ROM.icf::L2R47.dec"/>
#Rim2R47CustId=X,10,S

#RimL2R47=X,1,S
C(4,#CustId,S,$)
T(2,@Rim2R47CustId,#CustId)
RESET_RIM(#RimL2R47,L2R47)
S(L2R47,1,#Rim2R47CustId)
R(1,L2R47)


! 案件序號
#CaseSeq=A,3,I
IF(#CHAIN==0,$,s)
@V(7)
@V(2,0)

! 入帳日期(起始)
#EntryDateStart=D,7,I
IF(#CHAIN==0,$,s)
D(8)
@A(DATE,0,#EntryDateStart)

! 入帳日期(結束)
#EntryDateEnd=D,7,I
IF(#CHAIN==0,$,s)
D(8)
@A(DATE,0,#EntryDateEnd)
@IF(#EntryDateStart>#EntryDateEnd,V(P,[入帳日期-訖]不得小於[入帳日期-起]),s)



#MRKEY=_,_,S
C(4,#CustId,S,$)
T(2,#L2R47CustNo)

#RPTFG=A,1,S
E(0,0)

! 自動SUBMIT
#CHAINXMT=X,1,S
C(3,#CHAIN,1,E(0,@CHAIN,0)XMT(),$)
</sub>

!---------- 輸出共用變數宣告區 ----------
<sub type="RTN" name="AFXMT">
<include src="PRT.icf::PRTHEAD.rtn"/>
</sub>

!------------ TXFORM = L5971 -----------
<sub type="FORM" name="L5971">


#SCRTIL=_,_,S
T(3,[L5971] 債務協商交易明細表)

! ------HEADER------**109**
! 戶號
#OCustNo=A,7,L

! 案件序號
#OCaseSeq=9,3,L

! 案件種類
#OCaseKindCode=A,1,L
#OCaseKindCodeX=X,4,L
T(H,#OCaseKindCode,#CaseKindCodeHelp)

! 總本金餘額
#OMainPrincipalBal=m,14,L

! 累溢收金額
#OAccuOverAmt=m,14,L

! 期款
#ODueAmt=m,14,L

! 債權戶別 
#OCustLoanKind=X,1,L
#OCustLoanKindX=X,6,L
T(H,#OCustLoanKind,#CustLoanKindHelp)

! 累暫收金額
#OAccuTempAmt=m,14,L
! 累期款金額
#OAccuDueAmt=m,14,L

! 尚餘期數=期數TotalPeriod-已繳期數RepaidPeriod
#ORemainPeriod=A,3,L

! 借戶狀態
#OCustStatus=X,1,L
#OCustStatusX=X,6,L
T(H,#OCustStatus,#StatusHelp)

! 累新壽分攤金額
#OAccuSklShareAmt=m,14,L
! ------HEADER------

#LOOP=X,1,S
E(0,1)ASGN(LOOP$)
! ------OCCURS------ **102**
! 案件序號
#OOCaseSeq=X,3,O
! 入帳日期
#OOEntryDate=D,7,O
! 交易別
#OOTxKind=A,1,O
#OOTxKindX=X,8,O
T(H,#OOTxKind,#TxKindHelp)

! 交易金額
#OOTxAmt=+m,14,O
! 本金餘額
#OOTransPrincipalBal=m,14,O
! 會計日期
#OOAcDate=D,7,O
! 退還金額
#OOReturnAmt=m,14,O
! 新壽攤分
#OOSklShareAmt=m,14,O
! 撥付金額
#OOApprAmt=m,14,O
! 撥付製檔日
#OOExportDate=D,7,O

! 經辦
#OOTitaTlrNo=X,6,S
! 交易序號
#OOTitaTxtNo=9,8,S

! <入帳明細>=交易代碼(01 查詢)(2)+身分證號(#CustId)(10)+戶號(#OCustNo)(7)+案件序號(#OOCaseSeq)(3)+會計日期(#OOAcDate)(7)+經辦(#OOTitaTlrNo)(6)+交易序號(#OOTitaTxtNo)(8)
#OOBufNegTrans=X,43,S
T(2,01+#CustId+#OCustNo+#OOCaseSeq+#OOAcDate+#OOTitaTlrNo+#OOTitaTxtNo)

#OOBtnNegTrans=A,2,O
BIND(grid,{ cmd=CHAIN; ntxcd=L5972; ntxbuf=#OOBufNegTrans})

! <撥付明細>
#OOBufB=X,17,S
T(2,#OOExportDate+#CustId)
#OOBtnB=A,2,O
C(3,#OOTxKind,9,BIND(grid,cancel)
							 ,BIND(grid,{ cmd=CHAIN; ntxcd=L5973; ntxbuf=#OOBufB}))





!<撥付金額調整>
#OOBufC=X,50,S
T(2,#CustId+#OCustNo+#CaseSeq+#OOReturnAmt)
#OOBtnC=A,2,O
C(3,#OOExportDate,0,BIND(grid,{ cmd=CHAIN; ntxcd=L5711; ntxbuf=#OOBufC})
									 ,BIND(grid,cancel))
C(3,#OOTxKind,9,BIND(grid,cancel)
							 ,$)

! ------OCCURS------


</sub>

!------ 上行電文 TEXT ------
<sub type="TIM">
#CustId
#CaseSeq
#EntryDateStart
#EntryDateEnd
</sub>

!------ 下行電文TOM ------
<sub type="TOM">
<include src="COM.icf::TRCTL.tom"/>
<include src="ROM.icf::L2R47.tom"/>
<include src="HELPRIM.icf::HELPRIM.tom"/>
TXFORM=L5971
#OCustNo
#OCaseSeq
#OCaseKindCode
#OMainPrincipalBal
#OAccuOverAmt
#ODueAmt
#OCustLoanKind
#OAccuTempAmt
#OAccuDueAmt
#ORemainPeriod
#OCustStatus
#OAccuSklShareAmt
#OOCaseSeq
#OOEntryDate
#OOTxKind
#OOTxAmt
#OOTransPrincipalBal
#OOAcDate
#OOReturnAmt
#OOSklShareAmt
#OOApprAmt
#OOExportDate
#OOTitaTlrNo
#OOTitaTxtNo
^
</sub>


!---------- 單據輸出組合 ----------
<sub type="PART" prompt='{{#SCRTIL}} world' name="L5971" layout="cols=4;screen.width=[250,250,250,250];order=1;">
[
["[L5971                                 債務協商交易資料查詢"],
["戶號：",#OCustNo],
["案件序號：",#OCaseSeq],
["案件種類：",#OCaseKindCodeX],["債權戶別：",#OCustLoanKindX],["借戶狀態：",#OCustStatusX],
["總本金餘額：",#OMainPrincipalBal],["累繳金額：",#OAccuTempAmt],
["累溢收金額：",#OAccuOverAmt],["累期款金額：",#OAccuDueAmt],["累新壽分攤金額：",#OAccuSklShareAmt],
["期款：",#ODueAmt],["尚餘期數：",#ORemainPeriod],
]
</sub>


<sub type="SELECT">
#RPTFG=0,QUERY.GRID,L5971
#any={detail:true, header:'L5971.part', caption:'', width:1020, rowNum:20, rowList:[20,40,60]}
#OOEntryDate=入帳日期
{width:85,align:'center'}
#OOTxKindX=交易別
{width:85,align:'center'}
#OOTxAmt=交易金額
{width:85}
#OOTransPrincipalBal=本金餘額
{width:85}
#OOAcDate=會計日期
{width:85,align:'center'}
#OOBtnNegTrans=
{search:false,formatter:'cust:bind-button:入帳明細;L5972 債務協商入帳明細查詢',align:'center',canExport:false,width:65}
#OOReturnAmt=退還金額
{width:85}
#OOSklShareAmt=新壽攤分
{width:85}
#OOApprAmt=撥付金額
{width:85}
#OOExportDate=製檔日
{width:65,align:'center'}
#OOBtnB=撥付明細
{search:false,formatter:'cust:bind-button:撥付明細;L5973 最大債權撥付明細查詢',align:'center',canExport:false,width:75}
#OOBtnC=撥付金額調整
{search:false,formatter:'cust:bind-button:撥付金額調整;L5711 撥付金額調整',align:'center',canExport:false,width:100}
^
<include src="PRT.icf::INQ04.sel" map="i=L5971;cpi=15"/>
#CustId#EntryDateStart#EntryDateEnd
%
#OCustNo
#OCaseSeq
#OCaseKindCode
#OMainPrincipalBal
#OAccuOverAmt
#ODueAmt
#OCustLoanKind
#OAccuTempAmt
#OAccuDueAmt
#ORemainPeriod
#OCustStatus
#OAccuSklShareAmt
#OOCaseSeq
#OOEntryDate
#OOTxKind
#OOTxAmt
#OOTransPrincipalBal
#OOAcDate
#OOReturnAmt
#OOSklShareAmt
#OOApprAmt
#OOExportDate
^
</sub>
