!---------- BASIC LABEL Variables ----------
<sub type="SYS">
</sub>

<sub type="SYS" name="label">
!#TXCD
!T(3,L5711)
</sub>

<sub type="DC" name="BFHEAD">
<include src="COM.icf::BFHEAD.dec"/>
!起始交易記號  0:起始交易,1:非起始交易
#ORGFG=_,_,S
E(0,0)
</sub>

!---------- 交易畫面及個別交易變數宣告 ----------
<sub type="DC" name="L5711" layout="cols=3;screen.width=[150,250,150,250];printer.width=[20,80];order=1">
[
["[L5711]                                 撥付金額調整"],
["#FdCustNo+戶號",#CustNo],["#FdCaseSeq+案件序號",#CaseSeq],
["#FdCustId+身分證字號",#CustId],["#FdCustName+戶名",#CustName],
["#FdAmt+交易金額",#TxAmt],["#FdReturnAnt+退還金額",#ReturnAmt],
["#grid#,{id:1,expand:true,loop:30,row_height:1,s_cols:[], p_cols:[]}","","",
["債權機構","機構名稱","撥付金額","累計撥付金額" ],
[[#FinCode1],[#FinCodeName1],[#ApprAmt1],[#AccuApprAmt1],
]],
]

#FdCustId=X,2,L
#FdCustNo=X,2,L
#FdCustName=X,2,L
#FdCaseSeq=X,2,L
#FdAmt=X,2,L
#FdReturnAnt=X,2,L
!---------- AP TEXT AREA Variables ----------

#CHAIN=A,1,S
T(4,CHAIN$)
IF(#CHAIN!=1,V(P,此為連動交易，請從交易:L5971進入),$)


#NTXBUF=X,49,S
C(3,#CHAIN,1,T(4,NTXBUF$),S)
T(1,@CustId,#NTXBUF,1,10)
T(1,@CustNo,#NTXBUF,11,7)
T(1,@CaseSeq,#NTXBUF,18,3)
T(1,@TxAmt,#NTXBUF,21,14)
T(1,@ReturnAmt,#NTXBUF,35,14)

!Rim撥付金額累計
#SumRimApprAmt=m,14,S
E(0,0)


#SendL5R42=X,1,S
T(2,@RimCustNo,#CustNo)
T(2,@RimCaseSeq,#CaseSeq)
RESET_RIM(#SendL5R42,L5R42)
S(L5R42,1,#RimCustNo,#RimCaseSeq)
R(1,L5R42)
T(2,@CustName,#L5R42CustName)
T(2,@AcDate,#L5R42AcDate)
T(2,@TlrNo,#L5R42TlrNo)
T(2,@TxtNo,#L5R42TxtNo)
##loop{times:30,i:1}
T(2,@FinCode{i},#L5R42FinCode{i})
T(2,@FinCodeName{i},#L5R42FinCodeName{i})
E(0,@ApprAmt{i},#L5R42ApprAmt{i})
E(0,@AccuApprAmt{i},#L5R42AccuApprAmt{i})

!RIM撥付金額累計
E(0,@SumRimApprAmt,#SumRimApprAmt+#L5R42ApprAmt{i})
##end

INVOKEJS(SHOW,grd1,1)
##loop {times:30,i:1,j:2,k:3}
IF(#FinCode{i} !="",INVOKEJS(SHOW,grd1,{i},{i},1),INVOKEJS(SHOW,grd1,{i},30,0))
##end

#CustId=X,10,L
#CustNo=A,7,L
#CustName=X,100,L
#CaseSeq=A,3,L
#TxAmt=m,14,L
#ReturnAmt=m,14,L

#AcDate=D,7,S
#TlrNo=X,6,S
#TxtNo=A,8,S



##loop {times:30,i:1}

#FinCode{i}=X,8,L

#FinCodeName{i}=X,60,L

#ApprAmt{i}=m,14,I
C(4,#FinCode{i},s,$)


#AccuApprAmt{i}=m,14,L
IF(#L5R42ApprAmt{i}>#ApprAmt{i},E(0,#L5R42AccuApprAmt{i}-(#L5R42ApprAmt{i}-#ApprAmt{i})),$)
IF(#L5R42ApprAmt{i}<#ApprAmt{i},E(0,#L5R42AccuApprAmt{i}+(#ApprAmt{i}-#L5R42ApprAmt{i})),$)
IF(#L5R42ApprAmt{i}==#ApprAmt{i},E(0,#AccuApprAmt{i},#L5R42AccuApprAmt{i}),$)
##end


!畫面撥付金額累計
#SumApprAmt=m,14,S
E(0,0)
##loop {times:30,i:1}
E(0,#SumApprAmt,#SumApprAmt+#ApprAmt{i})
##end


#AmtCheck=X,1,S
IF(#SumRimApprAmt!=#SumApprAmt,V(P,撥付金額加總錯誤),$)

#AGAIN=X,1,S
E(0,1)ASGN(AGAIN$)

<include src="ROM.icf::L5R42Rim.dec"/>
<include src="ROM.icf::L5R42.dec"/>

</sub>

!---------- 輸出共用變數宣告區 ----------
<sub type="RTN" name="AFXMT">
<include src="PRT.icf::PRTHEAD.rtn"/>
</sub>

!------------ TXFORM = L5711 -----------
<sub type="FORM" name="L5711">
</sub>

!------ 上行電文 TEXT ------
<sub type="TIM">
#CustId
#CustNo
#CaseSeq
#AcDate
#TlrNo
#TxtNo
##loop {times:30,i:1}
#FinCode{i}
#FinCodeName{i}
#ApprAmt{i}
#AccuApprAmt{i}
##end
</sub>

!------ 下行電文TOM ------
<sub type="TOM">
<include src="COM.icf::TRCTL.tom"/>
<include src="ROM.icf::L5R42.tom"/>
<include src="HELPRIM.icf::HELPRIM.tom"/>
TXFORM=L5711

^
</sub>

!---------- 單據輸出組合 ----------
<sub type="SELECT">
</sub>
