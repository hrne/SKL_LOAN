----- BASIC LABEL Variables ----------
<sub type="SYS">
</sub>

<sub type="SYS" name="label">

!#TXCD
!T(3,L3901)

![資料表頭(HEADER)長度]
#INQHD=n,3,S
E(0,0)ASGN(INQHD$)

![每筆資料明細(OCCURS)長度]
#INQLEN=n,3,S
E(0,52)ASGN(INQLEN$)

![多筆查詢之一個畫面有N筆資料]
#INQREC=n,2,S
E(0,25)ASGN(INQREC$)

![畫面顯示的明細間的高度]
#LOOPH=n,3,S
E(0,1)ASGN(LOOPHEIGHT$)

![每張印錄單列印的筆數]
#INQPRT=n,2,S
E(0,40)ASGN(INQPRT$)

</sub>

<sub type="DC" name="BFHEAD">
<include src="COM.icf::BFHEAD.dec"/>
!起始交易記號  0:起始交易,1:非起始交易
#ORGFG=_,_,S
E(0,0)

#button=x,1,S
K(MODIFYBUTTON,試算)

</sub>

!---------- 交易畫面及個別交易變數宣告 ----------
<sub type="DC" name="p1" layout="cols=3;screen.width=[130,370,130,370];printer.width=[20,20];order=1">
[
["[L3901]                                 貸 款 試 算"],
["@*@本金",#Principal],
["@*@攤還方式",#AmortizedCode,#AmortizedCodeX],
["@*@週期基準",#FreqBase,#FreqBaseX],
["@*@貸放期限(期數)",#MaxTerm,#LoanTermX],
["@*@繳息週期",#PayIntFreq,#PayIntFreqX],
["@@@寬限期",#GracePeriod,#GracePeriodX],
["#grid#,{id:1,expand:true,loop:3,row_height:1,s_cols:[20,20,20], p_cols:[20,20,20]}","@*@利率","","",
["起期數","迄期數","利率"],
[[#STerm1],[#ETerm1],[#Rate1],"@%@@"
]],
["@@@最後一期餘額",#FinalBal],
["@*@顯示方式",
<include src="COM.icf::RPTFG.scr"/>
],
]

!---------- AP TEXT AREA Variables ----------
<include src="HELPRIM.icf::HELPRIM.rtn"/>
!FacmAmortizedCode
#CDDEF0001=x,25,S
T(3,CdCode.FacmAmortizedCode)

#FacmAmortizedCodeHelp=x,1024,S

![週期基準]
#CDDEF0002=x,30,S
T(3,CdCode.FreqBase)

#FreqBaseHelp=x,1024,S

#FacmAmortizedCodeHelpRim=X,1,S
RESET_RIM(#FacmAmortizedCodeHelpRim,XXR99)
S(XXR99,01,#CDDEF0001,#CDDEF0002)
R(1,XXR99)
CALL(#HelpProc)
T(2,@FacmAmortizedCodeHelp,#HelpDesc1)
T(2,@FreqBaseHelp,#HelpDesc2)


#CHAIN=A,1,S
T(4,CHAIN$) 
INVOKEJS(SHOW,grd1_3,0)
INVOKEJS(SHOW,grd1_4,0)

![本金]
!必須輸入
#Principal=m,14,I
@V(2,0)


![攤還方式] 
!1.按月繳息 2.到期取息  3.本息平均法  4.本金平均法
!必須輸入  
#AmortizedCode=A,1,I
HELP(#FacmAmortizedCodeHelp)
@V(H,#FacmAmortizedCodeHelp)
! HELP(L2DEF,FacmAmortizedCodeDef,FacmAmortizedCode,FacmAmortizedCodeX)
! @V(E,0,L2DEF,FacmAmortizedCodeDef)

#AmortizedCodeX=X,12,L
T(H,#AmortizedCode,#FacmAmortizedCodeHelp)
! T(A,#AmortizedCode,L2DEF,FacmAmortizedCodeDef,FacmAmortizedCode,FacmAmortizedCodeX)            

![週期基準]  
!2:月 3:週
!必須輸入,內定值為月 
#FreqBase=A,1,I
HELP(#FreqBaseHelp)
!到期取息者,週期基準固定為月不必輸入=>改為可輸入計算天數利息
E(0,2)
C(3,#AmortizedCode,1,s,$) 
!C(3,#AmortizedCode,2,s,$)  
@V(H,#FreqBaseHelp)

#Freq=A,1,S
C(2,#FreqBase,$,T(3,@LoanTermX,日),T(3,@LoanTermX,個月),T(3,@LoanTermX,週))
C(2,#FreqBase,$,T(3,@GracePeriodX,期),T(3,@GracePeriodX,期),T(3,@GracePeriodX,期))
C(2,#FreqBase,$,T(3,@PayIntFreqX,日),T(3,@PayIntFreqX,個月),T(3,@PayIntFreqX,週))

#FreqBaseX=X,10,L
T(H,#FreqBase,#FreqBaseHelp)        


![貸放期限]
!必須輸入
#MaxTerm=n,4,I
@V(2,0)

#LoanTermX=X,10,L

![繳息週期]
!必須輸入
#PayIntFreq=n,2,I
E(0,0)
C(3,#AmortizedCode,2,s,$)
C(3,#FreqBase,3,E(0,2),E(0,1))
@
IF(#PayIntFreq>#MaxTerm,V(P,只可輸入1.2.3.4.6.12且不可大於貸放期限),$)
IF(#PayIntFreq==1||#PayIntFreq==2||#PayIntFreq==3||#PayIntFreq==4||#PayIntFreq==6||#PayIntFreq==12,$,V(P,只可輸入1.2.3.4.6.12且不可大於貸放期限))
! V(5,1,#MaxTerm)
! V(1,1,2,3,4,6,12)
! V(P,只可輸入1.2.3.4.6.12且不可大於貸放期限)

#LoanTerm=n,4,S
IF(#PayIntFreq==0,E(0,#MaxTerm),E(0,#MaxTerm/#PayIntFreq))

#WKFREQ1=n,3.2,S
C(3,#AmortizedCode,2,S,$)
E(99,#MaxTerm/#PayIntFreq)

#WKFREQ2=n,3.2,S
C(3,#AmortizedCode,2,S,$)
E(2,#MaxTerm/#PayIntFreq)

#WKFREQ3=X,1,S
C(3,#AmortizedCode,2,S,$)
IF(#WKFREQ1==#WKFREQ2,$,V(P,此欄位錯誤，貸放期限須為繳息週期的倍數))

#PayIntFreqX=X,10,L

#GraceTemp1=n,3,S
E(0,0)
#GraceTemp2=n,3,S
E(0,0)

![寬限期]
#GracePeriod=n,3,I
E(0,0)
C(2,#AmortizedCode,s,s,s,$,$,s)
@V(5,0,#LoanTerm)

#GracePeriodX=X,10,L


#WKPRIN=m,14,S
E(0,#Principal-1)

#TempFreq=n,4,S
E(0,0)

#SkipFlag=A,1,S
E(0,0)

![利率]
#STerm1=n,4,S
E(0,1)

#ETerm1=n,4,I
IF(#ETerm1>#LoanTerm || #ETerm1 == 0,E(0,#LoanTerm),$)
@V(5,#STerm1,#LoanTerm)
#Rate1=n,2.4,I
@V(2,0)

#View1=A,1,S
C(3,#SkipFlag,1,S,$)
E(0,@TempFreq,#ETerm1+1)
IF(#ETerm1<#LoanTerm , INVOKEJS(SHOW,grd1_3,1) E(0,@SkipFlag,0),INVOKEJS(SHOW,grd1_3,0) INVOKEJS(SHOW,grd1_4,0) E(0,@SkipFlag,1))

#STerm2=n,4,S
C(3,#SkipFlag,1,S,$)
E(0,@TempFreq,#ETerm1+1)
E(0,#TempFreq)

#ETerm2=n,4,I
C(3,#SkipFlag,1,S,$)
IF(#ETerm2>#LoanTerm || #STerm2==#LoanTerm || #ETerm2 == 0 || #ETerm2 < #ETerm1,E(0,#LoanTerm),$)
IF(#STerm2==#LoanTerm,s,$)
@V(5,#STerm2,#LoanTerm)



#Rate2=n,2.4,I
C(3,#SkipFlag,1,S,$)
@V(2,0)

#View2=A,1,S
C(3,#SkipFlag,1,S,$)
E(0,@TempFreq,#ETerm2+1)
IF(#ETerm2<#LoanTerm,INVOKEJS(SHOW,grd1_4,1) E(0,@SkipFlag,0),INVOKEJS(SHOW,grd1_4,0) E(0,@SkipFlag,1))

#STerm3=n,4,S
C(3,#SkipFlag,1,S,$)
E(0,@TempFreq,#ETerm2+1)
E(0,#TempFreq)

#ETerm3=n,4,S
C(3,#SkipFlag,1,S,$)
E(0,#LoanTerm)

#Rate3=n,2.4,I
C(3,#SkipFlag,1,S,$)
@V(2,0)

#View3=A,1,S
E(0,@SkipFlag,0)
E(0,@TempFreq,0)

![最後一期餘額]
#FinalBal=m,14,I
C(3,#AmortizedCode,1,S,$)
C(3,#AmortizedCode,2,S,$)
@V(5,0,#WKPRIN)

<include src="COM.icf::RPTFG.dec"/>

</sub>

!---------- 輸出共用變數宣告區 ----------
<sub type="RTN" name="AFXMT">
<include src="PRT.icf::PRTHEAD.rtn"/>
</sub>


!---------- TXFORM = L3901 ----------
<sub type="FORM" name="L3901">

!#SCRPRT=_,_,S
!C(5,#TXFORM,L3901,$,S)

#SCRTIL=_,_,S
T(3,[L3901] 貸款試算)

!------ TOM(HEAD)   Variables (FOR OUTPUT SCREEN) ------
!------ TOM(OCCURS) Variables (FOR OUTPUT SCREEN) ------
#DASH1=X,1,S
T(3,-)

#DASH2=X,1,S
T(3,/)

#SPC1=X,1,S
T(3, )

!------ TOM(OCCURS) Variables (FOR OUTPUT SCREEN) ------
#LOOP=X,1,S
T(3,1)ASGN(LOOP$)

#OLoanTerm=A,4,O

#OPrincipal=m,14,O

#OInterest=m,14,O

#OSum=m,14,O
E(0,#OPrincipal+#OInterest)

#OBalance=m,14,O

</sub>


!------ 上行電文 ------
<sub type="TIM">

#Principal#STerm1#ETerm1#Rate1#STerm2#ETerm2#Rate2#STerm3#ETerm3#Rate3#AmortizedCode#FreqBase#LoanTerm#GracePeriod#PayIntFreq#FinalBal
</sub>


!------ 下行電文TOM ------
<sub type="TOM">

TXFORM=L3901
#OLoanTerm#OPrincipal#OInterest#OBalance^

<include src="HELPRIM.icf::HELPRIM.tom"/>
<include src="COM.icf::TRCTL.tom"/>
</sub>

!--------- OUTPUT畫面 --------

<sub type="PART" name="L3901" layout="cols=1;screen.width=[100,1000];printer.width=[20,20];order=1">
[
["[L3901]                                 貸 款 試 算"],
[""],
]
</sub>

!---------- 單據輸出組合 ----------
<sub type="SELECT">

#RPTFG=0,QUERY.GRID,L3901
#any={header:'L3901.part',caption:'[L3901] 貸款試算',shrinkToFit:'false',width:1030,rowNum:12, rowList:[12,36,60]}

#OLoanTerm=繳款期數 
{width:90,align:'center'}

#OPrincipal=應繳本金 
{width:180}

#OInterest=應繳利息 
{width:180}

#OSum=本利合計
{width:180}

#OBalance=放款餘額
{width:180}

^

<include src="PRT.icf::INQ01.sel" map="i=L3901;cpi=15"/>
#Principal#AmortizedCode#AmortizedCodeX#FreqBase#FreqBaseX#MaxTerm#LoanTermX#PayIntFreq#PayIntFreqX#GracePeriod#GracePeriodX
#STerm1#ETerm1#Rate1#STerm2#ETerm2#Rate2#STerm3#ETerm3#Rate3#FinalBal
%#OLoanTerm#OPrincipal#OInterest#OSum#OBalance@^
</sub>
