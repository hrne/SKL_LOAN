!---------- BASIC LABEL Variables ----------
<sub type="SYS">
</sub>

<sub type="SYS" name="label">
!#TXCD
!T(3,L4500)
</sub>

<sub type="DC" name="BFHEAD">
<include src="COM.icf::BFHEAD.dec"/>
!起始交易記號  0:起始交易,1:非起始交易
#ORGFG=_,_,S
E(0,0)
</sub>

!---------- 交易畫面及個別交易變數宣告 ----------
<sub type="DC" name="L4500" layout="cols=1;screen.width=[130,870];printer.width=[20,80];order=1">
[
["[L4500]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@設定員工扣薪日程表"],
["#FdEmpDeductYear+扣薪年份",#EmpDeductYear],
["#FdAgType1+流程別",#AgType1,#AgType1X],
["#FdCopyCode+複製",#CopyCode,#CopyCodeX],
["#grid#,{id:1,expand:true,loop:13,row_height:1,s_cols:[130,130,130], p_cols:[]}","","",
["工作月份","媒體日期","入帳日期"],
[[#MonthA1],[#MediaDateA1],[#EntryDateA1],
[]]],
["#grid#,{id:2,expand:true,loop:12,row_height:1,s_cols:[130,130,130], p_cols:[]}","","",
["月份","媒體日期","入帳日期"],
[[#MonthB1],[#MediaDateB1],[#EntryDateB1],
[]]],
] 

#FdEmpDeductYear=X,2,L
T(3,*)
#FdAgType1=X,2,L
T(3,*)
#FdCopyCode=X,2,L
T(3, )

#EmpDeductFlagHelp=x,20,S
T(3,1:15日薪;2:非15日薪)

#CHAIN=A,1,S
T(4,CHAIN$) 

#NowDate=D,7,S
E(0,#SYSDATE)

<include src="HELPRIM.icf::HELPRIM.rtn"/>
#EmpDeductTypeRim=x,50,S
T(3,CdCode.EmpDeductType)

#EmpDeductTypeHelpRim=X,1,S
RESET_RIM(#EmpDeductTypeHelpRim,XXR99)
S(XXR99,01,#EmpDeductTypeRim)
R(1,XXR99)
CALL(#HelpProc)
T(2,@EmpDeductTypeHelp,#HelpDesc1)

#EmpDeductTypeHelp=x,1024,S


#NTXBUF=X,8,S
! C(3,#CHAIN,1,T(4,NTXBUF$),S)
! T(1,@AcDate,#NTXBUF,1,1)

! 預設:第一次三個都印
!      第二次只印媒體明細
#ColDIS=A,1,S
T(1,@EmpDeductYear,#NowDate,1,3)
INVOKEJS(SHOW,L4500_4,0)
INVOKEJS(SHOW,L4500_5,0)

#EmpDeductYear=A,3,I
@V(2,0)

#EmpDeductYearTemp=m,7,S
E(0,#EmpDeductYear*10000)
E(0,#EmpDeductYearTemp+101)

! 每次僅修改一個流程別
! 流程別決定要修改欄位
#AgType1=X,1,I
HELP(#EmpDeductTypeHelp)
@V(H,#EmpDeductTypeHelp)


#AgType1X=X,30,L
T(H,#AgType1,#EmpDeductTypeHelp)

! 複製碼決定要調rim欄位
#CopyCode=X,1,I
HELP(#EmpDeductTypeHelp)
@
C(4,#CopyCode,S,$)
V(6,#AgType1,#AgType1)C(4,#CopyCode,$,V(H,#EmpDeductTypeHelp))


#CopyCodeX=X,20,L
T(H,#CopyCode,#EmpDeductTypeHelp)

<include src="ROM.icf::L4R15.dec"/>

#RimYear=A,3,S
E(0,#EmpDeductYear)
! 若複製碼為空則為流程別調rim
#RimAgType1=X,1,S
C(4,#CopyCode,T(2,#AgType1),T(2,#CopyCode))

#RimL4r15=X,1,S
RESET_RIM(#RimL4r15,L4R15)
S(L4R15,1,#RimYear,#RimAgType1)
R(1,L4R15)
E(0,@EmpDeductFlag,#L4r15EmpDeductFlag)
##loop {times:13,i:1}
E(0,@EntryDateA{i},#L4r15EntryDateA{i})
E(0,@MediaDateA{i},#L4r15MediaDateA{i})
##end
##loop {times:12,i:1}
E(0,@EntryDateB{i},#L4r15EntryDateB{i})
E(0,@MediaDateB{i},#L4r15MediaDateB{i})
##end

!4,5 15日薪
#EmpDeductFlag=A,1,S
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,
INVOKEJS(SHOW,L4500_4,0)INVOKEJS(SHOW,L4500_5,1),
INVOKEJS(SHOW,L4500_4,1)INVOKEJS(SHOW,L4500_5,0))

#EmpDeductFlagX=x,15,L 
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,T(2,15日薪),T(2,非15日薪))

##loop {times:13,i:1}
#ColLoop{i}=A,1,S
E(0,@MonthA{i},{i})
IF(13>{i},E(0,@MonthB{i},{i}),$)
##end

! 非15日薪
##loop {times:13,i:1,z:0}
#MonthA{i}=m,2,L

#MonCheckFrom{i}=A,2,S
IF(#MonthA{i}==1,T(2,01),$)
IF(#MonthA{i}==1,s,$)
E(0,@MonCheckFrom{i},#MonthA{i}-1)

#MonCheckTo{i}=A,2,S
IF(#MonthA{i}==13,T(2,01),$)
IF(#MonthA{i}==13,s,$)
E(0,@MonCheckTo{i},#MonthA{i}+1)

#CheckMsgA{i}=x,20,S
T(2,請輸入月份為+#MonCheckFrom{i}+~+#MonCheckTo{i})

#MediaDateA{i}=D,7,I
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,s,$)
@A(DATE,0,#MediaDateA{i})

#MediaDateACheck{i}=x,30,S
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,s,$)
IF({i}>1,
IF(#MediaDateA{i}<=#MediaDateA{z},
T(2,請輸入日期大於+#MediaDateA{z}),s),
IF(#MediaDateA{i}<#EmpDeductYearTemp,
T(2,請輸入日期大於+#EmpDeductYearTemp),s))
V(P,#MediaDateACheck{i})

#MediaDateMonthCheckA{i}=x,2,S
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,s,$)
IF(#MediaDateA{i}>0,$,s)
T(1,@MediaDateMonthCheckA{i},#MediaDateA{i},4,2)
IF(#MonthA{i}==13,
IF(#MediaDateMonthCheckA{i}==#MonCheckFrom{i}||#MediaDateMonthCheckA{i}==#MonCheckTo{i},$,V(P,#CheckMsgA{i})),
IF(#MediaDateMonthCheckA{i}>=#MonCheckFrom{i}&&#MediaDateMonthCheckA{i}<=#MonCheckTo{i},$,V(P,#CheckMsgA{i}))
)

#EntryDateA{i}=D,7,I
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,s,$)
@A(DATE,0,#EntryDateA{i})

#EntryDateACheck{i}=x,30,S
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,s,$)
IF({i}>1,
IF(#EntryDateA{i}<=#EntryDateA{z},
T(2,請輸入日期大於+#EntryDateA{z}),s),s)
V(P,#EntryDateACheck{i})

#EntryDateMonthCheckA{i}=x,2,S
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,s,$)
IF(#EntryDateA{i}>0,$,s)
T(1,@EntryDateMonthCheckA{i},#EntryDateA{i},4,2)
IF(#MonthA{i}==13,
IF(#EntryDateMonthCheckA{i}==#MonCheckFrom{i}||#EntryDateMonthCheckA{i}==#MonCheckTo{i},$,V(P,#CheckMsgA{i})),
IF(#EntryDateMonthCheckA{i}>=#MonCheckFrom{i}&&#EntryDateMonthCheckA{i}<=#MonCheckTo{i},$,V(P,#CheckMsgA{i})))
IF(#MediaDateA{i}>#EntryDateA{i},V(P,入帳日不可小於媒體日),$)

##end


! 15日薪
##loop {times:12,i:1,z:0}
#MonthB{i}=m,2,L

#CheckMsgB{i}=x,20,S
T(2,請輸入月份為+#MonthB{i})

#MediaDateB{i}=D,7,I
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,$,s)
@A(DATE,0,#MediaDateB{i})

#MediaDateBCheck{i}=x,30,S
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,$,s)
IF({i}>1,
IF(#MediaDateB{i}<=#MediaDateB{z},
T(2,請輸入日期大於+#MediaDateB{z}),s),
IF(#MediaDateB{i}<#EmpDeductYearTemp,
T(2,請輸入日期大於+#EmpDeductYearTemp),s))
V(P,#MediaDateBCheck{i})

#MediaDateMonthCheckB{i}=x,2,S
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,$,s)
IF(#MediaDateB{i}>0,$,s)
T(1,@MediaDateMonthCheckB{i},#MediaDateB{i},4,2)
IF(#MediaDateMonthCheckB{i}==#MonthB{i},$,V(P,#CheckMsgB{i}))

#EntryDateB{i}=D,7,I
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,$,s)
@A(DATE,0,#EntryDateB{i})

#EntryDateBCheck{i}=x,30,S
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,$,s)
IF({i}>1,
IF(#EntryDateB{i}<=#EntryDateB{z},
T(2,請輸入日期大於+#EntryDateB{z}),s),s)
V(P,#EntryDateBCheck{i})

#EntryDateMonthCheckB{i}=x,2,S
IF(#EmpDeductFlag==4 || #EmpDeductFlag==5,$,s)
IF(#EntryDateB{i}>0,$,s)
T(1,@EntryDateMonthCheckB{i},#EntryDateB{i},4,2)
IF(#EntryDateMonthCheckB{i}==#MonthB{i},$,V(P,#CheckMsgB{i}))
IF(#MediaDateB{i}>#EntryDateB{i},V(P,入帳日不可小於媒體日),$)

##end



</sub>

!---------- 輸出共用變數宣告區 ----------
<sub type="RTN" name="AFXMT">
<include src="PRT.icf::PRTHEAD.rtn"/>

</sub>

!------------ TXFORM = L4500 -----------
<sub type="FORM" name="L4500">

</sub>

!------ 上行電文 TEXT ------
<sub type="TIM">
#EmpDeductYear
#AgType1
#CopyCode

##loop {times:13,i:1}
#MonthA{i}
#EntryDateA{i}
#MediaDateA{i}
##end

##loop {times:12,i:1}
#MonthB{i}
#EntryDateB{i}
#MediaDateB{i}
##end


</sub>

!------ 下行電文TOM ------
<sub type="TOM">
<include src="HELPRIM.icf::HELPRIM.tom"/>
<include src="COM.icf::TRCTL.tom"/>
TXFORM=L4500

^
<include src="ROM.icf::L4R15.tom"/>

</sub>

!---------- 單據輸出組合 ----------
<sub type="SELECT">
<include src="PRT.icf::UPD01.sel"/>

</sub>
