!---------- BASIC LABEL Variables ----------
<sub type="SYS">
</sub>

<sub type="SYS" name="label">
!#TXCD
!T(3,L5701)
</sub>

<sub type="DC" name="BFHEAD">
<include src="COM.icf::BFHEAD.dec"/>
!起始交易記號  0:起始交易,1:非起始交易
#ORGFG=_,_,S
E(0,0)
</sub>

!---------- 交易畫面及個別交易變數宣告 ----------
<sub type="DC" name="L5701" layout="cols=3;screen.width=[170,330,200,600];printer.width=[20,80];order=1">
[
["[L5701]                                 債權維護"],
[#<->#,"#FdFunctionCodeX+功能",#FunctionCodeX],
[#<->#,"#FdCustId+身分證字號",#CustId,#BtnDetail],
["#FdCustNo+戶號",#CustNo],["#FdCaseSeq+案件序號",#CaseSeq],
[#<->#,"#FdIsMainFin+最大債權",#IsMainFin],
["#FdCaseKindCode+案件種類",#CaseKindCode,#CaseKindCodeX],["#FdCourtCode+#CourtCodeFildName",#CourtCode,#CourtCodeX],
["#FdCustLoanKind+債權戶別",#CustLoanKind,#CustLoanKindX],["#FdPayerCustNo+#PayerCustNoFildName",#PayerCustNo,#PayerCustName],
[#<->#,"#FdStatus+債權戶況",#Status,#StatusX],
[#<->#,"#FdDeferYMStart+延期繳款年月+(+起+)",#DeferYMStartX],
[#<->#,"#FdDeferYMEnd+延期繳款年月+(+訖+)",#DeferYMEndX],
["#FdApplDate+協商申請日",#ApplDate],["#FdChgCondDate+#ChgCondDateFildName",#ChgCondDate],
[#<->#,"#FdDueAmt+期款",#DueAmt],
["#FdTotalPeriod+期數",#TotalPeriod],["#FdIntRate+計息條件",#IntRate,"%"],
["#FdFirstDueDate+首次應繳日",#FirstDueDate],["#FdLastDueDate+還款結束日",#LastDueDate],
["#FdFieldName+#FieldName",#TotalContrAmt],["#FdNextPayDate+下次應繳日",#NextPayDate],
[#<->#,"#FdMainFinCode+最大債權機構",#MainFinCode,#MainFinCodeName],
["#FdTwoStepCode+二階段註記",#TwoStepCode,#TwoStepCodeX],
[#<->#,"@",#BTNK,#BtnConnect,#BTND,#BTNF,#BTNE,#BTNG,#BTNH,#BTNI,#BTNJ,#BTNL],
["#grid#,{id:1,expand:true,loop:30,row_height:1,s_cols:[], p_cols:[]}","","",
["債權機構","","機構名稱","簽約金額","債權比例% ","期款","註銷日期","註銷本金"],
[[#NegFinShareFinCode1],[#BtnBankCode1],[#FinCodeName1],[#NegFinShareContractAmt1],[#NegFinShareAmtRatio1],[#NegFinShareDueAmt1],[#NegFinShareCancelDate1],[#NegFinShareCancelAmt1],
]],
]

#HidePayerCustNo=@,1,S
HIDE(#FdPayerCustNo,#PayerCustNoFildName,#PayerCustNo)
#ShowPayerCustNo=@,1,S
SHOW(#FdPayerCustNo,#PayerCustNoFildName,#PayerCustNo)

#HideChgCondDate=@,1,S
HIDE(#FdChgCondDate,#ChgCondDateFildName,#ChgCondDate)
#ShowChgCondDate=@,1,S
SHOW(#FdChgCondDate,#ChgCondDateFildName,#ChgCondDate)

!受理調解機構代號
#HideCourtCode=@,1,S
HIDE(#FdCourtCode,#CourtCodeFildName,#CourtCode,#CourtCodeX)
#ShowCourtCode=@,1,S
SHOW(#FdCourtCode,#CourtCodeFildName,#CourtCode,#CourtCodeX)


#FdFunctionCodeX=X,2,L
#FdCustId=X,2,L
T(3,*)
#FdCustNo=X,2,L
#FdCaseSeq=X,2,L
#FdIsMainFin=X,2,L
T(3,*)
#FdCaseKindCode=X,2,L
T(3,*)
#FdStatus=X,2,L
T(3,*)
#FdDeferYMStart=X,2,L
#FdDeferYMEnd=X,2,L
#FdApplDate=X,2,L
T(3,*)
#FdTotalPeriod=X,2,L
T(3,*)
#FdFirstDueDate=X,2,L
T(3,*)
#FdFieldName=X,1,L
T(3,*)
#FdNextPayDate=X,2,L
T(3,  )
#FdMainFinCode=X,2,L
T(3,*)
#FdTwoStepCode=X,2,L
T(3,*)
#FdCustLoanKind=X,2,L
T(3,*)
#FdPayerCustNo=X,1,L
T(3,*)
!受理調解機構代號
#FdCourtCode=X,1,L
T(3,*)

#FdPrincipalBal=X,2,L
T(3,  )
#FdDueAmt=X,2,L
T(3,*)
#FdIntRate=X,2,L
T(3,*)
#FdLastDueDate=X,2,L
T(3,*)
#FdChgCondDate=X,1,L
T(3,*)
#PayerCustNoFildName=X,10,L
T(3,付款人戶號)
#ChgCondDateFildName=X,18,L
T(3,申請變更還款條件日)
#CourtCodeFildName=X,16,L
T(3,受理調解機構代號)


! [#<->#,"@",#BtnConnect,#BTND,#BTNF,#BTNE,#BTNG,#BTNH,#BTNI],
!--延期繳款年月
!---------- AP TEXT AREA Variables ----------

#Hide=X,1,S
INVOKEJS(SHOW,grd1,0)
HIDE(#BtnDetail)
HIDE(#BTND,#BTNF,#BTNE,#BTNG,#BTNH,#BTNI,#BTNJ,#BTNL)
!HIDE(#BtnBankCode)

#BtnDetail=X,1,S,ui:button;value:交易明細;enable:1;tabbable:0
#BtnConnect=X,1,S,ui:button;value:聯絡電話;enable:1;tabbable:0
#BTND=X,1,S,ui:button;value:註銷債權;enable:1;tabbable:0
#BTNF=X,1,S,ui:button;value:毀諾;enable:1;tabbable:0
#BTNE=X,1,S,ui:button;value:取消毀諾;enable:1;tabbable:0
#BTNG=X,1,S,ui:button;value:變更還款條件;enable:1;tabbable:0
#BTNH=X,1,S,ui:button;value:喘息期;enable:1;tabbable:0
#BTNI=X,1,S,ui:button;value:二階段新增;enable:1;tabbable:0
#BTNJ=X,1,S,ui:button;value:債權異動歷程;enable:1;tabbable:0
#BTNK=X,1,S,ui:button;value:債務人聯絡電話;enable:1;tabbable:0
#BTNL=X,1,S,ui:button;value:喘息期歷程;enable:1;tabbable:0

! 查詢銀行代碼
#BUFBankCode=X,1,S

##loop {times:30,i:1}
#BtnBankCode{i}=X,1,S,ui:button;value:查詢;enable:1;tabbable:0
#BINDBankCode{i}=X,1,S
BIND(#BtnBankCode{i},click, {cmd=CHAIN; ntxcd=L5974; ntxbuf=#BUFBankCode;ntxbuf5=type<-1:NegFinShareFinCode{i}<-OOFinCode})
HIDE(#BtnBankCode{i})
##end

<include src="ROM.icf::L5R12.dec"/>
<include src="ROM.icf::L2R07.dec"/>
<include src="ROM.icf::L5R43.dec"/>
<include src="ROM.icf::L5R43Rim.dec"/>
<include src="HELPRIM.icf::HELPRIM.rtn"/>

! Status1
#StatusCode=x,20,S
T(3,CdCode.NegStatus)
#StatusHelp=x,1024,S

! CustLoanKind2
#CustLoanKindCode=x,20,S
T(3,CdCode.CustLoanKind)
#CustLoanKindHelp=x,1024,S

! CaseKindCode3
#CaseKindCodeCode=x,20,S
T(3,CdCode.CaseKindCode)
#CaseKindCodeHelp=x,1024,S

! FunctionCode4
#FunctionCodeCode=x,20,S
T(3,CdCode.FunctionCode)
#FunctionCodeHelp=x,1024,S



#HelpRim=X,1,S
RESET_RIM(#HelpRim,XXR99)
S(XXR99,01,#StatusCode,#CustLoanKindCode,#CaseKindCodeCode,#FunctionCodeCode)
R(1,XXR99)
CALL(#HelpProc)
T(2,@StatusHelp,#HelpDesc1)
T(2,@CustLoanKindHelp,#HelpDesc2)
T(2,@CaseKindCodeHelp,#HelpDesc3)
T(2,@FunctionCodeHelp,#HelpDesc4)


!YN
#YNHelp=X,50,S
T(3,Y: ;N: )

#CHAIN=A,1,S
T(4,CHAIN$)
IF(#CHAIN==0,V(P,本交易為連動交易，請從交易:[L5071債權案件明細查詢]進入),$)

!做完交易自動更新原畫面
#AutoReFresh=A,1,S
C(3,#CHAIN,1,$,S)
E(0,1)
ASGN(CAUTO$)

#PreValue=A,1,S
T(2,@Status,0)
CALL(#HidePayerCustNo)
CALL(#HideCourtCode)
! CALL(#HideChgCondDate)
! 新增

!#ChainInsertNTXBUF=X,22,S
!IF(#CHAIN==1,$,S)
!C(3,#CHAIN,1,T(4,NTXBUF$),S)
!T(1,@FunctionCode,#ChainInsertNTXBUF,1,2)
!IF(#FunctionCode=="01",$,S)
!T(1,@CustId,#ChainInsertNTXBUF,3,10)
! T(1,@CustNo,#ChainInsertNTXBUF,13,7)

#DATE=D,8,S
T(4,DATE$)

#DT=D,7,S
T(1,#DATE,2,7)

#NTXBUF=X,22,S
C(3,#CHAIN,1,T(4,NTXBUF$),S)
T(1,@FunctionCode,#NTXBUF,1,2)
IF(#FunctionCode!="01",$,s)
T(1,@CustId,#NTXBUF,3,10)
T(1,@CustNo,#NTXBUF,13,7)
T(1,@CaseSeq,#NTXBUF,20,3)



!控制錯誤訊息0:不報錯;1:報錯
#L5R43Flag=A,1,S
E(0,0)

#RimCustId=X,10,S
T(2,#CustId)

#RimCustNo=A,7,S

#RimCaseSeq=A,3,S

! 調RIM L5R01
<include src="ROM.icf::L5R01.dec"/>
#SendL5r01=X,1,S
IF(#FunctionCode!="01",$,S)
C(4,#CustId,S,$)
C(3,#CustNo,0,S,$)
C(3,#CaseSeq,0,S,$)
T(2,@RimCustId,#CustId)
T(2,@RimCustNo,#CustNo)
T(2,@RimCaseSeq,#CaseSeq)
RESET_RIM(#SEND_L5R01,L5R01)
S(L5R01,1,#FunctionCode,#RimCustId,#RimCustNo,#RimCaseSeq)
R(1,L5R01)
T(2,@CustId,#L5r01CustId)
E(0,@CustNo,#L5r01CustNo)
E(0,@CaseSeq,#L5r01CaseSeq)
T(2,@CaseKindCode,#L5r01CaseKindCode)
T(2,@CustLoanKind,#L5r01CustLoanKind)
T(2,@Status,#L5r01Status)
C(3,#L5r01DeferYMStart,0,$,T(2,@DeferYMStartX,#L5r01DeferYMStart))
C(3,#L5r01DeferYMEnd,0,$,T(2,@DeferYMEndX,#L5r01DeferYMEnd))
T(2,@ApplDate,#L5r01ApplDate)
E(0,@DueAmt,#L5r01DueAmt)
E(0,@TotalPeriod,#L5r01TotalPeriod)
E(0,@IntRate,#L5r01IntRate)
T(2,@FirstDueDate,#L5r01FirstDueDate)
T(2,@LastDueDate,#L5r01LastDueDate)
IF (#FunctionCode=="09"||#FunctionCode=="11",$,T(2,@NextPayDate,#L5r01NextPayDate))
T(2,@IsMainFin,#L5r01IsMainFin)
E(0,@TotalContrAmt,#L5r01TotalContrAmt)
T(2,@MainFinCode,#L5r01MainFinCode)
E(0,@PrincipalBal,#L5r01PrincipalBal)
T(2,@TwoStepCode,#L5r01TwoStepCode)
T(2,@PayerCustNo,#L5r01PayerCustNo)
T(2,@ChgCondDate,#L5r01ChgCondDate)
T(2,@CourtCode,#L5r01CourtCode)
##loop {times:30,i:1}
T(2,@NegFinShareFinCode{i},#L5r01NegFinShareFinCode{i})
T(2,@FinCodeName{i},#L5r01NegFinShareFinName{i})
E(0,@NegFinShareContractAmt{i},#L5r01NegFinShareContractAmt{i})
E(0,@NegFinShareAmtRatio{i},#L5r01NegFinShareAmtRatio{i})
E(0,@NegFinShareDueAmt{i},#L5r01NegFinShareDueAmt{i})
T(2,@NegFinShareCancelDate{i},#L5r01NegFinShareCancelDate{i})
E(0,@NegFinShareCancelAmt{i},#L5r01NegFinShareCancelAmt{i})
##end
T(H,@CaseKindCodeX,#CaseKindCode,#CaseKindCodeHelp)
T(H,@CustLoanKindX,#CustLoanKind,#CustLoanKindHelp)
T(H,@StatusX,#Status,#StatusHelp)
C(5,#IsMainFin,Y,T(2,@FieldName,簽約總金額),T(2,@FieldName,新壽總金額))
! 下方按鈕
T(2,@BufConnect,#CustId)

#Send2L5R43=x,1,S
RESET_RIM(#Send2L5R43,L5R43)
S(L5R43,1,#FunctionCode,#L5R43Flag,#CourtCode)
R(1,L5R43)
T(2,@CourtCodeX,#L5R43CourtItem)


! 案件種類-調解才需要填寫受理調解機構代號
#CheckCourtCode1=X,1,S
C(4,L5r01CaseKindCode,s,$)
IF(#CaseKindCode=="2",CALL(#ShowCourtCode),CALL(#HideCourtCode))

#CheckCustLoanKind1=X,1,S
C(4,#L5r01PayerCustNo,s,$)
IF(#CustLoanKind==3,CALL(#ShowPayerCustNo),CALL(#HidePayerCustNo))

#RimTxCode=X,5,S
T(2,#TXCD)
	
#SendL2r07A=X,1,S
C(3,#PayerCustNo,0,s,$)
T(3,@RimCustId, )
E(0,@RimCustNo,#PayerCustNo)
RESET_RIM(#SendL2r07,L2R07)
S(L2R07,1,#RimTxCode,#RimCustId,#RimCustNo)
R(1,L2R07)
C(4,#L2r07CustName,S,T(2,@PayerCustName,#L2r07CustName))


#CheckChgCondDateIsZero=X,1,S
IF(#ChgCondDate!=0,CALL(#ShowChgCondDate),
    IF(#FunctionCode==9,CALL(#ShowChgCondDate),CALL(#HideChgCondDate)))
!債權銀行3碼改為8碼
#RimBankCode=X,8,S

#RimL5r12A=X,1,S
IF(#MainFinCode!="",$,s)
T(2,@RimBankCode,#MainFinCode)
S(L5R12,1,#RimBankCode,#FunctionCode)
R(1,L5R12)
T(2,@MainFinCodeName,#L5r12BankItem)

#B1=X,1,S
IF(#FunctionCode=="05",$,S)
!依戶況修改
!SHOW(#BTND,#BTNF,#BTNE,#BTNG,#BTNH,#BTNI,#BTNJ)
HIDE(#BTND,#BTNF,#BTNE,#BTNG,#BTNH,#BTNI)
SHOW(#BTNJ,#BTNL)
IF(#Status=="0",SHOW(#BTND,#BTNF,#BTNG,#BTNH,#BTNI),$)
IF(#Status=="2",SHOW(#BTNE),$)
IF(#Status=="4",SHOW(#BTNF),$)
IF(#CaseKindCode==1,HIDE(#BTND,#BTNG,#BTNI),$)
IF(#TwoStepCode=="N",HIDE(#BTNI),$)
IF(#IsMainFin=="N",HIDE(#BTND,#BTNJ),$)


! INVOKEJS(SHOW,grd1,1) BTN那行
#TestShowNegFinShare=X,1,S
IF(#IsMainFin=="Y",$,s)
IF(#L5r01IsMainFin=="Y",$,s)
INVOKEJS(SHOW,grd1,1)
##loop {times:30,i:1,j:2,k:3}
IF(#NegFinShareFinCode{i} !="",INVOKEJS(SHOW,grd1,{i},{i},1),INVOKEJS(SHOW,grd1,{i},{j},0))
##end

! <交易明細>
#BufDetail=X,22,S
T(2,05+#CustId+#CustNo+#CaseSeq)

#BindInsert=X,1,S
BIND(#BtnDetail,click, {cmd=CHAIN; ntxcd=L5971; ntxbuf=#BufDetail})

! 毀諾註記 1:設定 2:取消
#RUINFG=X,1,S

#LABELB=X,8,O
C(3,#RUINFG,2,T(2,取消毀諾),T(2,毀諾))

#Pre_DueAmt=m,16,S
#Pre_TotalContrAmt=m,16,S
#Pre_IntRate=m,6,S

#SearchCode=X,2,S
T(2,05)

! 功能代碼
#FunctionCode=X,2,S
C(3,#CHAIN,0,T(2,01),s)
C(3,#CHAIN,0,s,$)
@IF(#FunctionCode=="01",SHOW(#BtnDetail),HIDE(#BtnDetail))
E(0,@FUNCIND,#FunctionCode)

#FunctionCodeX=X,24,L
T(H,#FunctionCode,#FunctionCodeHelp)
!C(2,#FunctionCode,$,K(MODIFYBUTTON,新增),K(MODIFYBUTTON,修改),$,K(MODIFYBUTTON,刪除),K(MODIFYBUTTON,查詢))
K(MODIFYBUTTON,#FunctionCodeX)
C(3,#FunctionCode,5,K(NOBUTTON,CLOSEY),$)

!刪除隱藏重新交易按鈕
#AGAIN=X,1,S
C(3,#FunctionCode,1,S,$)
E(0,1)ASGN(AGAIN$)

#ShowFd=X,1,S
C(2,#FunctionCode,T(3, ),T(3,*),T(3,*),T(3, ),T(3, ),T(3, ),T(3, ),T(3, ),T(3, ),T(3,*),T(3, ),T(3,*))
T(2,@FdIsMainFin,#ShowFd)     
T(2,@FdApplDate,#ShowFd)
T(2,@FdTotalPeriod,#ShowFd)
T(2,@FdFirstDueDate,#ShowFd)
T(2,@FdMainFinCode,#ShowFd)
T(2,@FdTwoStepCode,#ShowFd)
T(2,@FdDueAmt,#ShowFd)
T(2,@FdIntRate,#ShowFd)
T(2,@FdLastDueDate,#ShowFd)
!新增*必須輸入記號欄位
T(2,@FdCustId,#ShowFd)
T(2,@FdCaseKindCode,#ShowFd)
T(2,@FdStatus,#ShowFd)
T(2,@FdApplDate,#ShowFd)
T(2,@FdFieldName,#ShowFd)
T(2,@FdStatus,#ShowFd)
T(2,@FdCustLoanKind,#ShowFd)
T(2,@FdPayerCustNo,#ShowFd)
T(2,@FdChgCondDate,#ShowFd)
T(2,@FdCourtCode,#ShowFd)



!顯示框線
#WKTF=X,1,S
IF (#FunctionCode=="01",T(F,@CustId,1),T(F,@CustId,0))
IF (#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",
                        T(F,@IsMainFin,1)T(F,@CaseKindCode,1)T(F,@CustLoanKind,1)T(F,@Status,1)
                        T(F,@DeferYMStartX,0)T(F,@DeferYMEndX,0)T(F,@ApplDate,1)T(F,@DueAmt,1)T(F,@TotalPeriod,1)
                        T(F,@IntRate,1)T(F,@FirstDueDate,1)T(F,@LastDueDate,1)T(F,@TotalContrAmt,1)T(F,@MainFinCode,1)T(F,@TwoStepCode,1)T(F,@PayerCustNo,1)T(F,@ChgCondDate,1)T(F,@CourtCode,1)T(F,@LastDueDate,1)
                        ,
                        T(F,@CustId,0)T(F,@IsMainFin,0)T(F,@CaseKindCode,0)T(F,@CustLoanKind,0)T(F,@Status,0)
                        T(F,@DeferYMStartX,0)T(F,@DeferYMEndX,0)T(F,@ApplDate,0)T(F,@DueAmt,0)T(F,@TotalPeriod,0)
                        T(F,@IntRate,0)T(F,@FirstDueDate,0)T(F,@LastDueDate,0)T(F,@TotalContrAmt,0)T(F,@MainFinCode,0)T(F,@TwoStepCode,0)T(F,@PayerCustNo,0)T(F,@ChgCondDate,0)T(F,@CourtCode,0)T(F,@LastDueDate,0))                       
!新增時戶況不可輸入,固定=0
IF (#FunctionCode=="01",T(F,@Status,0),$) 
!喘息期只能改此二欄位
IF (#FunctionCode=="02" || #FunctionCode=="10",T(F,@DeferYMStartX,1)T(F,@DeferYMEndX,1),$) 
!變更還款條件&二階段新增:不能改的欄位
IF (#FunctionCode=="09"||#FunctionCode=="11",T(F,@IsMainFin,0)T(F,@CaseKindCode,0)T(F,@Status,0)T(F,@ApplDate,0),$)
 
#WKTF2=A,1,S
IF (#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",E(0,1),E(0,0))
#WKTF3=A,1,S
IF (#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="06"||#FunctionCode=="09"||#FunctionCode=="11",E(0,1),E(0,0))
##loop {times:30,i:1}
T(F,#NegFinShareFinCode{i},#WKTF2)
T(F,#NegFinShareContractAmt{i},#WKTF2)
T(F,@NegFinShareAmtRatio{i},#WKTF3)
T(F,@NegFinShareDueAmt{i},#WKTF3)
T(F,@NegFinShareCancelDate{i},#WKTF3)
T(F,@NegFinShareCancelAmt{i},0)
##end
##loop {times:30,i:1}
C(2,#WKTF2,HIDE(#BtnBankCode{i}),SHOW(#BtnBankCode{i}))
##end
                                  
! 身分證字號 //
#CustId=X,10,I
IF(#FunctionCode==#SearchCode,s,$)
C(3,#CHAIN,0,$,IF(#L5r01CustId!="",s,$))
@T(3,@CustNo,)
V(7)
@A(ID_UNINO,0,#CustId)

! 調RIM找CustNo
<include src="ROM.icf::L5R09.dec"/>


#SendL5r09=X,1,S
IF(#FunctionCode=="01",$,S)
C(4,#CustId,S,$)
T(2,@RimCustId,#CustId)
E(0,@RimCustNo,0)
RESET_RIM(#SendL5r09,L5R09)
S(L5R09,1,#RimTxCode,#RimCustId,#RimCustNo)
R(1,L5R09)
T(2,@CustNo,#L5r09CustNo)

! 戶號
#CustNo=A,7,L


! 案件序號
#CaseSeq=A,3,L


! 最大債權
#IsMainFin=X,1,I
IF(#FunctionCode=="01"||#FunctionCode=="02",$,s)
HELP(#YNHelp)
@V(H,#YNHelp)
C(5,#IsMainFin,Y,T(2,@FieldName,簽約總金額),T(2,@FieldName,新壽總金額))
IF(#FunctionCode==02 || #FunctionCode==01,C(5,#IsMainFin,Y,T(2,@MainFinCode,458)T(2,@MainFinCodeName,),$),$)
IF(#FunctionCode==02 || #FunctionCode==01,C(5,#IsMainFin,N,IF(#MainFinCode=="458",T(2,@MainFinCode,)T(2,@MainFinCodeName,),$),$),$)
IF(#FunctionCode==02,IF(#MainFinCode!=#L5r01MainFinCode,C(5,#IsMainFin,Y,CALL(#IsMainFinIsY),CALL(#IsMainFinIsN)),s),$)
IF(#FunctionCode==01,C(5,#IsMainFin,Y,CALL(#IsMainFinIsY),CALL(#IsMainFinIsN)),$)


#IsMainFinIsY=@,1,S
INVOKEJS(SHOW,grd1,1)
INVOKEJS(SHOW,grd1,3,31,0)


#IsMainFinIsN=@,1,S

INVOKEJS(SHOW,grd1,0)


##loop {times:30,i:1}
T(2,@NegFinShareFinCode{i},)
T(2,@FinCodeName{i},)
E(0,@NegFinShareContractAmt{i},0)
E(0,@NegFinShareAmtRatio{i},0)
E(0,@NegFinShareDueAmt{i},0)
E(0,@NegFinShareCancelDate{i},0)
E(0,@NegFinShareCancelAmt{i},0)
##end

! 案件種類
#CaseKindCode=X,1,I
IF(#FunctionCode=="01"||#FunctionCode=="02",$,s)
HELP(#CaseKindCodeHelp)
@T(3,@CaseKindCodeX,)
V(H,#CaseKindCodeHelp)

#CaseKindCodeX=X,4,L
T(H,#CaseKindCode,#CaseKindCodeHelp)

! 案件種類-調解才需要填寫受理調解機構代號
#CheckCourtCode=X,1,S
IF(#CaseKindCode=="2",CALL(#ShowCourtCode),CALL(#HideCourtCode))

#CourtCode=X,3,I
IF(#CaseKindCode=="2",$,S)
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)

@T(3,@CourtCodeX,)
V(7)



#Send1L5R43=x,1,S
C(4,#CourtCode,s,$)
E(0,@L5R43Flag,1)
RESET_RIM(#Send1L5R43,L5R43)
S(L5R43,1,#FunctionCode,#L5R43Flag,#CourtCode)
R(1,L5R43)
T(2,@CourtCodeX,#L5R43CourtItem)

#CourtCodeX=X,50,L

! 債權戶別
#CustLoanKind=X,1,I
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
HELP(#CustLoanKindHelp)
@T(3,@CustLoanKindX,)
V(H,#CustLoanKindHelp)

#CustLoanKindX=X,6,L
T(H,#CustLoanKind,#CustLoanKindHelp)

#CheckCustLoanKind=X,1,S
IF(#CustLoanKind==3,CALL(#ShowPayerCustNo),CALL(#HidePayerCustNo))

! 付款人戶號-債權戶別為保證人才需要填寫
#PayerCustNo=A,7,I
IF(#CustLoanKind==3,$,S)
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
@T(3,@PayerCustName,)
V(2,0)
! 債權戶況
! 0:正常
! 1:已變更
! 2:毀諾
! 3:結案
! 4:未生效
!預設值不可改:新增時預設=0,變更還款條件時預設=0,二階段新增時預設=4

#SendL2r07=X,1,S
C(3,#PayerCustNo,0,S,$)
T(3,@RimCustId, )
E(0,@RimCustNo,#PayerCustNo)
RESET_RIM(#SendL2r07,L2R07)
S(L2R07,1,#RimTxCode,#RimCustId,#RimCustNo)
R(1,L2R07)


#PayerCustName=X,100,L
C(3,#PayerCustNo,0,S,$)
C(4,#L2r07CustName,S,T(2,#L2r07CustName))

#Status=X,1,I
C(3,#FunctionCode,01,T(2,@Status,0),$)
C(3,#FunctionCode,09,T(2,@Status,0),$)
C(3,#FunctionCode,11,T(2,@Status,4),$)
IF(#FunctionCode=="02",$,s)
HELP(#StatusHelp)
@T(3,@StatusX,)
V(H,#StatusHelp)

#StatusX=X,6,L
T(H,#Status,#StatusHelp)

!延期繳款年月(起)
#DeferYMStartX=X,5,I
IF(#FunctionCode=="02"||#FunctionCode=="10",$,s)
@
A(YM,0,#DeferYMStartX)
IF(#FunctionCode=="02"||#FunctionCode=="10",$,s)
C(3,#L5r01DeferYMStart,0,s,$)
A(YM,1,#DeferYMStartX)

#DeferYMStart=A,5,S
C(4,#DeferYMStartX,s,$)
E(0,#DeferYMStartX)

!延期繳款年月(訖)
#DeferYMEndX=X,5,I
IF(#FunctionCode=="02"||#FunctionCode=="10",$,s)
C(4,#DeferYMStartX,S,$)
@
A(YM,0,#DeferYMEndX)

#DeferYMEnd=A,5,S
C(4,#DeferYMEndX,s,$)
E(0,#DeferYMEndX)

#DeferYMCheck=X,1,S
IF(#DeferYMStart>#DeferYMEnd,V(P,[延期繳款年月-訖]不得小於[延期繳款年月-起]),s)
! @A(YM13,0,#DeferYMStart)

! 協商申請日
#ApplDate=D,7,I
IF(#FunctionCode=="01"||#FunctionCode=="02",$,s)
D(8)
@V(7)A(DATE,0,#ApplDate)

! 變更還款日期
! 設定毀諾->變更還款日期必填寫
#ChgCondDate=D,7,I
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
D(8)
IF(#FunctionCode==9,$,s)
@V(7)
@A(DATE,0,#ChgCondDate)



! 期款
#DueAmt=m,14,I
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
@IF(#DueAmt>0,s,V(P,[期款]請輸入大於零的整數))
! 期數
#TotalPeriod=A,3,I
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
@IF(#TotalPeriod>0,s,V(P,[期數]請輸入大於零的整數))
! 計息條件
!#IntRate=m,2.4,I
#IntRate=m,2.2,I
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)

! 首次應繳日
#FirstDueDate=D,7,I
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
D(8)
@V(7)A(DATE,0,#FirstDueDate)

!還款結束日計算
#TotalPeriodN=N,3,S
E(0,#TotalPeriod-1)
#LastDueDateN=A,8,S
D(7,2,#FirstDueDate,#TotalPeriodN,0)

! 還款結束日-新增債協主檔時才預設為計算出的新還款結束日,否則應預設帶出調RIM的值
#LastDueDate=D,7,I
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
IF(#FunctionCode=="02",$,E(0,#LastDueDateN))
D(8)
@V(7)A(DATE,0,#LastDueDate)
IF(#FirstDueDate>#LastDueDate,V(P,[還款結束日]不得小於[首次應繳日]),s)

! 文字欄位
#FieldName=X,10,L

#NextPayDate=D,7,L

! #Msg1=x,1,S
! T(3,[)

! #Msg2=x,1,S
! T(3,])

! #Msg3=x,18,S
! T(3,請輸入正整數)

! #ErrorMsg=x,50,S
! T(2,#FieldName,#Msg3)

! (新壽)簽約總金額
#TotalContrAmt=m,14,I
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
@IF(#TotalContrAmt<#DueAmt,V(P,金額有誤),s)
!@IF(#TotalContrAmt==0,$,s)
!@V(P,請輸入正整數)

! 最大債權機構
#MainFinCode=X,8,I
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
IF(#IsMainFin=="Y",s,$)
@T(3,@MainFinCodeName,)
V(7)

!總本金餘額
#PrincipalBal=m,14,S
IF(#FunctionCode=="01"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
E(0,#TotalContrAmt)

#CheckMainFinCode=X,1,S
IF(#IsMainFin=="N",$,S)
IF(#MainFinCode=="458",$,S)
V(P,最大債權機構不可為458)

#RimL5r12B=X,1,S
IF(#MainFinCode!="",$,S)
T(2,@RimBankCode,#MainFinCode)
RESET_RIM(#RimL5r12B,L5R12)
S(L5R12,1,#RimBankCode,#FunctionCode)
R(1,L5R12)
T(2,@MainFinCodeName,#L5r12BankItem)

! #TwoStepCode=X,1,I
! IF(#FunctionCode==#SearchCode,s,$)
! HELP(Y: ;N: ;1:第一階段還款;2:第二階段還款)
! @V(3,Y,N,1,2)
! @IF(#TwoStepCode=="Y",T(2,1),$)
! @IF(#L5r01TwoStepCode==1 && #FunctionCode=="11",T(2,2),s)

#TwoStepCode=X,1,I
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
HELP(#YNHelp)
@T(3,@TwoStepCodeX,)
V(3,Y,N,1,2)
@IF(#TwoStepCode=="Y",T(2,1),$)
@IF(#L5r01TwoStepCode==1 && #FunctionCode==11,T(2,2),s)

#TwoStepCodeX=x,18,L
SWITCH(#TwoStepCode,
    Y,T(2,),
    1,T(2,第一階段還款),
    2,T(2,第二階段還款),
    3,T(2,第三階段還款),
    4,T(2,第四階段還款),
    5,T(2,第五階段還款),
    N,T(2,)
)

! 最大債權機構
#MainFinCodeName=X,120,L

! <聯絡電話>
#BufConnect=X,18,S
T(2,1+#CustId+#CustNo)

#BINDB=X,1,S
BIND(#BtnConnect,click, {cmd=CHAIN; ntxcd=L1905; ntxbuf=#BufConnect})
! L1905 顧客聯絡電話查詢

!債務人連絡電話
#PhoneConnect=X,13,S
T(2,048+#CustId)

#BINDK=X,1,S
BIND(#BTNK,click, {cmd=CHAIN; ntxcd=L8030; ntxbuf=#PhoneConnect})



! <刪除>
! #BUFC=X,22,S
! T(2,04+#BufKey)
! #BINDC=X,1,S
! BIND(#BtnDelete,click, {cmd=CHAIN; ntxcd=L5701; ntxbuf=#BUFC})

! 交易Key值=身分證號(10)+戶號(7)+案件序號(3)
#BufKey=X,20,S
T(2,#CustId+#CustNo+#CaseSeq)

! <註銷債權>
#BUFD=X,22,S
T(2,06+#BufKey)
#BINDD=X,1,S
BIND(#BTND,click, {cmd=CHAIN; ntxcd=L5701; ntxbuf=#BUFD})

! <取消毀諾> NegMain.Status=2:毀諾-> 0:正常
#BUFE=X,22,S
T(2,08+#BufKey)
#BINDE=X,1,S
C(3,#RUINFG,1,BIND(grid,cancel),
BIND(#BTNE,click, {cmd=CHAIN; ntxcd=L5701; ntxbuf=#BUFE}))
! UPDATE NegMain Status=1 已變更

! <設定毀諾> NegMain.Status=2 毀諾
#BUFF=X,22,S
T(2,03+#BufKey)
#BINDF=X,1,S
C(3,#RUINFG,2,BIND(grid,cancel),
BIND(#BTNF,click, {cmd=CHAIN; ntxcd=L5701; ntxbuf=#BUFF}))
! UPDATE NegMain Status=2 毀諾

! <變更還款條件> 原本的 NegMain.Status=1:已變更 新增一筆資料
#BUFG=X,22,S
T(2,09+#BufKey)
#BINDG=X,1,S
BIND(#BTNG,click, {cmd=CHAIN; ntxcd=L5701; ntxbuf=#BUFG})
! UPDATE NegMain Status=1 已變更

! <喘息期>
#BUFH=X,22,S
T(2,10+#BufKey)
#BINDH=X,1,S
BIND(#BTNH,click, {cmd=CHAIN; ntxcd=L5701; ntxbuf=#BUFH})
!L8XXX

! <二階段新增>
#BUFI=X,22,S
T(2,11+#BufKey)
#BINDI=X,1,S
BIND(#BTNI,click, {cmd=CHAIN; ntxcd=L5701; ntxbuf=#BUFI})
! UPDATE TwoStepCode=Y 2階段註記


! 交易Key值=戶號(7)+案件序號(3)
! <債權異動歷程>
#BUFJ=X,10,S
T(2,#CustNo+#CaseSeq)

#BINDJ=X,1,S
BIND(#BTNJ,click, {cmd=CHAIN; ntxcd=L5981; ntxbuf=#BUFJ})

#DT_MONTH=A,5,S
T(1,#DATE,2,5)
#DT_01=A,2,S
E(0,1)
#ST_DTS=D,7,S
T(2,#DT_MONTH+#DT_01)

!<喘息期歷程>
#BUFL=X,69,S
T(2,0010101+#DT+L5701+                  +#CustNo+000+000)

#BINDL=X,1,S
BIND(#BTNL,click, {cmd=CHAIN; ntxcd=L6932; ntxbuf=#BUFL})

!RIM簽約金額
#RimContractAmtX=m,14,S
E(0,0)

##loop {times:30,i:1}
#ContracAmtX{i}=X,1,S
E(0,@RimContractAmtX,#RimContractAmtX+#L5r01NegFinShareContractAmt{i})
##end


##loop {times:30,i:1,j:0,k:2}
! Test{i}==1 繼續 Test{i}==0跳過
#Test{i}=X,1,S
T(3,1)
IF({i}!=1,$,s)
IF(#NegFinShareFinCode{j}=="",T(3,0),T(3,1))

#NegFinShareFinCode{i}=X,8,I
IF(#CaseKindCode=="1",s,$)
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
IF(#IsMainFin=="Y",$,S)
IF(#Test{i}=="0",S,$)
IF({i}==1,$,C(4,#NegFinShareFinCode{j},INVOKEJS(SHOW,grd1_{i},0),INVOKEJS(SHOW,grd1_{i},1)))
@IF({i}==1,$,IF(#NegFinShareFinCode{i}=="",S,$))
C(4,#NegFinShareFinCode1,V(7),$)
C(4,#NegFinShareFinCode{i},INVOKEJS(SHOW,grd1,{i},0),INVOKEJS(SHOW,grd1,{k},1))
!檢核不可重複債權機構
C(3,{i},2,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1)),$)
C(3,{i},3,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2)),$)
C(3,{i},4,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3)),$)
C(3,{i},5,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4)),$)
C(3,{i},6,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5)),$)
C(3,{i},7,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6)),$)
C(3,{i},8,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7)),$)
C(3,{i},9,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8)),$)
C(3,{i},10,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9)),$)
C(3,{i},11,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10)),$)
C(3,{i},12,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11)),$)
C(3,{i},13,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12)),$)
C(3,{i},14,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13)),$)
C(3,{i},15,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14)),$)
C(3,{i},16,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15)),$)
C(3,{i},17,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16)),$)
C(3,{i},18,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17)),$)
C(3,{i},19,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17,#NegFinShareFinCode18)),$)
C(3,{i},20,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17,#NegFinShareFinCode18,#NegFinShareFinCode19)),$)
C(3,{i},21,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17,#NegFinShareFinCode18,#NegFinShareFinCode19,#NegFinShareFinCode20)),$)
C(3,{i},22,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17,#NegFinShareFinCode18,#NegFinShareFinCode19,#NegFinShareFinCode20,#NegFinShareFinCode21)),$)
C(3,{i},23,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17,#NegFinShareFinCode18,#NegFinShareFinCode19,#NegFinShareFinCode20,#NegFinShareFinCode21,#NegFinShareFinCode22)),$)
C(3,{i},24,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17,#NegFinShareFinCode18,#NegFinShareFinCode19,#NegFinShareFinCode20,#NegFinShareFinCode21,#NegFinShareFinCode22,#NegFinShareFinCode23)),$)
C(3,{i},25,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17,#NegFinShareFinCode18,#NegFinShareFinCode19,#NegFinShareFinCode20,#NegFinShareFinCode21,#NegFinShareFinCode22,#NegFinShareFinCode23,#NegFinShareFinCode24)),$)
C(3,{i},26,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17,#NegFinShareFinCode18,#NegFinShareFinCode19,#NegFinShareFinCode20,#NegFinShareFinCode21,#NegFinShareFinCode22,#NegFinShareFinCode23,#NegFinShareFinCode24,#NegFinShareFinCode25)),$)
C(3,{i},27,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17,#NegFinShareFinCode18,#NegFinShareFinCode19,#NegFinShareFinCode20,#NegFinShareFinCode21,#NegFinShareFinCode22,#NegFinShareFinCode23,#NegFinShareFinCode24,#NegFinShareFinCode25,#NegFinShareFinCode26)),$)
C(3,{i},28,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17,#NegFinShareFinCode18,#NegFinShareFinCode19,#NegFinShareFinCode20,#NegFinShareFinCode21,#NegFinShareFinCode22,#NegFinShareFinCode23,#NegFinShareFinCode24,#NegFinShareFinCode25,#NegFinShareFinCode26,#NegFinShareFinCode27)),$)
C(3,{i},29,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17,#NegFinShareFinCode18,#NegFinShareFinCode19,#NegFinShareFinCode20,#NegFinShareFinCode21,#NegFinShareFinCode22,#NegFinShareFinCode23,#NegFinShareFinCode24,#NegFinShareFinCode25,#NegFinShareFinCode26,#NegFinShareFinCode27,#NegFinShareFinCode28)),$)
C(3,{i},30,C(4,#NegFinShareFinCode{j},$,V(4,#NegFinShareFinCode1,#NegFinShareFinCode2,#NegFinShareFinCode3,#NegFinShareFinCode4,#NegFinShareFinCode5,#NegFinShareFinCode6,#NegFinShareFinCode7,#NegFinShareFinCode8,#NegFinShareFinCode9,#NegFinShareFinCode10,#NegFinShareFinCode11,#NegFinShareFinCode12,#NegFinShareFinCode13,#NegFinShareFinCode14,#NegFinShareFinCode15,#NegFinShareFinCode16,#NegFinShareFinCode17,#NegFinShareFinCode18,#NegFinShareFinCode19,#NegFinShareFinCode20,#NegFinShareFinCode21,#NegFinShareFinCode22,#NegFinShareFinCode23,#NegFinShareFinCode24,#NegFinShareFinCode25,#NegFinShareFinCode26,#NegFinShareFinCode27,#NegFinShareFinCode28,#NegFinShareFinCode29)),$)

#FinCodeName{i}=X,60,L
IF(#NegFinShareFinCode{i}=="",S,$)

#RimL5r12C{i}=X,1,S
IF(#NegFinShareFinCode{i}=="",S,$)
T(2,@RimBankCode,#NegFinShareFinCode{i})
S(L5R12,1,#RimBankCode,#FunctionCode)
R(1,L5R12)
T(2,@FinCodeName{i},#L5r12BankItem)


#NegFinShareContractAmt{i}=m,14,I
C(4,#NegFinShareFinCode{i},S,$)
IF(#CaseKindCode=="1",s,$)
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
IF(#IsMainFin=="Y",$,S)
IF(#Test{i}=="0",S,$)
IF(#NegFinShareFinCode{i}=="",S,$)
@V(2,0)

#CountShareRatio{i}=X,1,S
C(4,#NegFinShareFinCode{i},S,$)
IF(#CaseKindCode=="1",s,$)
IF(#IsMainFin=="Y",$,S)
IF(#FunctionCode=="01" || #FunctionCode=="09" || #FunctionCode=="11",$,s)
E(0,@NegFinShareAmtRatio{i},#NegFinShareContractAmt{i}*100/#TotalContrAmt)

#NegFinShareAmtRatio{i}=m,3.2,I
C(4,#NegFinShareFinCode{i},S,$)
IF(#CaseKindCode=="1",s,$)
IF(#IsMainFin=="Y",$,S)
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="06"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
@V(2,0)


#CountShareDueAmt{i}=X,1,S
C(4,#NegFinShareFinCode{i},S,$)
IF(#CaseKindCode=="1",s,$)
IF(#IsMainFin=="Y",$,S)
IF(#FunctionCode=="01" || #FunctionCode=="09" || #FunctionCode=="11",$,s)
E(0,@NegFinShareDueAmt{i},#NegFinShareContractAmt{i}*#DueAmt/#TotalContrAmt)


#NegFinShareDueAmt{i}=m,14,I
IF(#CaseKindCode=="1",s,$)
IF(#IsMainFin=="Y",$,S)
C(4,#NegFinShareFinCode{i},S,$)
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="06"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
@V(2,0)

#NegFinShareCancelDate{i}=D,7,I
IF(#CaseKindCode=="1",s,$)
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="06"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
IF(#IsMainFin=="Y",$,S)
IF(#Test{i}=="0",S,$)
IF(#NegFinShareFinCode{i}=="",S,$)
D(8)
@A(DATE,0,#NegFinShareCancelDate{i})


#NegFinShareCancelAmt{i}=m,14,O
IF(#CaseKindCode=="1",s,$)
IF(#NegFinShareCancelDate{i}>0,$,S)
IF(#FunctionCode=="01"||#FunctionCode=="09"||#FunctionCode=="11",E(0,#NegFinShareContractAmt{i}),$)
IF(#FunctionCode=="02"||#FunctionCode=="06",C(3,#RimContractAmtX,0,E(0,#NegFinShareContractAmt{i}),E(0,#NegFinShareContractAmt{i}*#PrincipalBal/#RimContractAmtX)),$)



##end


!債權比例-檢查用
#CountAmtRatioX=m,3.2,S
E(0,0)

!債權比例-計算用
#CountAmtRatioXX=m,3.2,S
E(0,0)

!期金-檢查用
#CountDueAmtX=m,14,S
E(0,0)

!期金-計算用
#CountDueAmtXX=m,14,S
E(0,0)

!簽約金額(不包含註銷金額)
#CountContractAmtX=m,14,S
E(0,0)

!註銷金額
#CountCancelAmtX=m,14,S
E(0,0)



!若簽約總金額修改則放總金額否則放調RIM簽約金額合計
#ContractAmtX=m,14,S
IF(#FunctionCode=="01"||#FunctionCode=="06"||#FunctionCode=="09"||#FunctionCode=="11",E(0,#TotalContrAmt),$)
IF(#FunctionCode=="02",IF(#L5r01TotalContrAmt!=#TotalContrAmt,E(0,#TotalContrAmt),E(0,#RimContractAmtX)),$)


##loop {times:30,i:1}
!簽約金額計算(不包含註銷金額)
#Amt1{i}=X,1,S
IF(#IsMainFin=="Y",$,S)
IF(#CaseKindCode=="1",s,$)
C(3,#NegFinShareCancelDate{i},0,$,s)
E(0,@CountContractAmtX,#CountContractAmtX+#NegFinShareContractAmt{i})

!註銷金額合計
#CancelAmtX{i}=X,1,S
E(0,@CountCancelAmtX,#CountCancelAmtX+#NegFinShareCancelAmt{i})
##end

##loop {times:30,i:1,j:0,k:2}

#AmtRatioX{i}=X,1,S
IF(#FunctionCode=="01"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
C(3,#NegFinShareCancelAmt{i},0,$,s)
C(3,#NegFinShareContractAmt{i},0,s,$)
E(0,@NegFinShareAmtRatio{i},#NegFinShareContractAmt{i}*100/(#ContractAmtX-#CountCancelAmtX))
E(0,#CountAmtRatioXX,#CountAmtRatioXX+#NegFinShareAmtRatio{i})

!最後一筆比例用減的
#cAmtRatio{i}=X,1,S
IF(#FunctionCode=="01"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
IF({i}==1,s,$)
IF({k}==31,s,$)
C(4,#NegFinShareFinCode{i},s,$)
C(4,#NegFinShareFinCode{k},$,s)
C(3,#NegFinShareCancelDate{i},0,E(0,@NegFinShareAmtRatio{i},100+#NegFinShareAmtRatio{i}-#CountAmtRatioXX),E(0,@NegFinShareAmtRatio{j},100+#NegFinShareAmtRatio{j}-#CountAmtRatioXX))


!計算期款
#DueAmtX{i}=X,1,S
IF(#FunctionCode=="01"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
C(3,#NegFinShareCancelAmt{i},0,$,s)
C(3,#NegFinShareAmtRatio{i},0,s,$)
E(0,@NegFinShareDueAmt{i},#NegFinShareAmtRatio{i}*#DueAmt/100)
E(0,#CountDueAmtXX,#CountDueAmtXX+#NegFinShareDueAmt{i})

!最後一筆期金用減的
#cDueAmtX{i}=X,1,S
IF(#FunctionCode=="01"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
IF({i}==1,s,$)
IF({k}==31,s,$)
C(4,#NegFinShareFinCode{i},s,$)
C(4,#NegFinShareFinCode{k},$,s)
C(3,#NegFinShareCancelDate{i},0,E(0,#NegFinShareDueAmt{i},#DueAmt+#NegFinShareDueAmt{i}-#CountDueAmtXX),E(0,#NegFinShareDueAmt{j},#DueAmt+#NegFinShareDueAmt{j}-#CountDueAmtXX))

##end

##loop {times:30,i:1}

!比例合計
#Amt2{i}=X,1,S
C(3,#NegFinShareCancelDate{i},0,$,s)
E(0,@CountAmtRatioX,#CountAmtRatioX+#NegFinShareAmtRatio{i})

!期款合計
#Amt3{i}=X,1,S
C(3,#NegFinShareCancelDate{i},0,$,s)
E(0,@CountDueAmtX,#CountDueAmtX+#NegFinShareDueAmt{i})
##end


#CContracAmt1=X,1,S
IF(#IsMainFin=="Y",$,S)
IF(#CaseKindCode=="1",s,$)
IF(#FunctionCode=="01"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
C(3,#CountCancelAmtX,0,IF(#CountContractAmtX!=#ContractAmtX,V(P,簽約金額合計錯誤),$),IF(#CountContractAmtX!=#ContractAmtX-#CountCancelAmtX,V(P,簽約金額合計錯誤),$))

#CContracAmt2=X,1,S
IF(#FunctionCode=="02",$,s)
IF(#L5r01TotalContrAmt!=#TotalContrAmt,$,s)
C(3,#CountCancelAmtX,0,IF(#CountContractAmtX!=#ContractAmtX,V(P,簽約金額合計錯誤),$),IF(#CountContractAmtX!=#ContractAmtX-#CountCancelAmtX,V(P,簽約金額合計錯誤),$))


#CContracAmt3=X,1,S
IF(#FunctionCode=="02",$,s)
##loop {times:30,i:1}
C(3,#NegFinShareContractAmt{i},#L5r01NegFinShareContractAmt{i},$,C(3,#CountCancelAmtX,0,IF(#CountContractAmtX!=#ContractAmtX,V(P,簽約金額合計錯誤),$),IF(#CountContractAmtX!=#ContractAmtX-#CountCancelAmtX,V(P,簽約金額合計錯誤),$)))
##end


#CAmtRatio=X,1,S
IF(#IsMainFin=="Y",$,S)
IF(#CaseKindCode=="1",s,$)
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="06"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
IF(#CountAmtRatioX!=100,V(P,債權比例總和錯誤),$)



#CAmtDueAmt=X,1,S
IF(#IsMainFin=="Y",$,S)
IF(#CaseKindCode=="1",s,$)
IF(#FunctionCode=="01"||#FunctionCode=="02"||#FunctionCode=="06"||#FunctionCode=="09"||#FunctionCode=="11",$,s)
IF(#CountDueAmtX!=#DueAmt,V(P,期款總和錯誤),$)






##loop {times:30,i:1}
#Testc{i}=X,1,S
C(4,#NegFinShareFinCode{i},$,s)
INVOKEJS(SHOW,grd1,{i},{i},0)

##end

!參考編號
#MRKEY=_,_,S
T(2,#CustNo+#CaseSeq)


</sub>

!---------- 輸出共用變數宣告區 ----------
<sub type="RTN" name="AFXMT">
<include src="PRT.icf::PRTHEAD.rtn"/>
</sub>

!------------ TXFORM = L5701 -----------
<sub type="FORM" name="L5701">
</sub>

!------ 上行電文 TEXT ------
<sub type="TIM">
#FunctionCode
#CustId
#DeferYMStart
#DeferYMEnd
#CaseKindCode
#CourtCode
#CustLoanKind
#PayerCustNo
#CustNo
#CaseSeq
#Status
#ApplDate
#ChgCondDate
#DueAmt
#TotalPeriod
#IntRate
#FirstDueDate
#LastDueDate
#IsMainFin
#TotalContrAmt
#MainFinCode
#TwoStepCode
##loop {times:30,i:1}
#NegFinShareFinCode{i}
#NegFinShareContractAmt{i}
#NegFinShareAmtRatio{i}
#NegFinShareDueAmt{i}
#NegFinShareCancelDate{i}
#NegFinShareCancelAmt{i}
##end
</sub>

!------ 下行電文TOM ------
<sub type="TOM">
<include src="COM.icf::TRCTL.tom"/>
<include src="ROM.icf::L5R09.tom"/>
<include src="ROM.icf::L5R01.tom"/>
<include src="ROM.icf::L5R12.tom"/>
<include src="ROM.icf::L2R07.tom"/>
<include src="ROM.icf::L5R43.tom"/>
<include src="HELPRIM.icf::HELPRIM.tom"/>
TXFORM=L5701
#CustNo
^
</sub>

!---------- 單據輸出組合 ----------
<sub type="SELECT">
</sub>
