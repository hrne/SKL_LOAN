!---------- BASIC LABEL Variables ----------
<sub type="SYS">
</sub>

<sub type="SYS" name="label">
!#TXCD
!T(3,L5702)

![資料表頭(HEADER)長度]
#INQHD=n,3,S
E(0,109)ASGN(INQHD$)

![每筆資料明細(OCCURS)長度]
#INQLEN=n,3,S
E(0,0)ASGN(INQLEN$)

![多筆查詢之一個畫面有N筆資料]
#INQREC=n,2,S
E(0,40)ASGN(INQREC$)

![畫面顯示的明細間的高度]
#LOOPH=n,3,S
E(0,1)ASGN(LOOPHEIGHT$)

![每張印錄單列印的筆數]
#INQPRT=n,2,S
E(0,40)ASGN(INQPRT$)

</sub>

<sub type="DC" name="BFHEAD">
<include src="COM.icf::BFHEAD.dec"/>
!起始交易記號  0:起始交易,1:非起始交易
#ORGFG=_,_,S
E(0,1)
</sub>

!---------- 交易畫面及個別交易變數宣告 ----------
!---------- NegMain ----------.
!---NegTrans---
<sub type="DC" name="L5702" layout="cols=3;screen.width=[200,300,200,300];printer.width=[50,80];order=1">
[
["[L5702]                       債務協商作業-暫收入帳"],
[#<->#,"@","債務協商案件主檔資料"],
["身分證字號",#CustId],["案件序號",#CaseSeq],
["戶號",#CustNo],["戶名",#CustName],
["債權戶況",#NewStatusX],["債權戶別",#CustLoanKindX],
[#<->#,"協商申請日",#ApplDate],
["每期期款",#MainDueAmt],["總期數",#TotalPeriod],
["每期利率",#IntRate,"％"],["已繳期數",#RepaidPeriod,#NewRepaidPeriod],
["最大債權",#IsMainFin],["最大債權機構",#MainFinCode,#MainFinCodeX],
[#<->#,"總本金餘額",#OrgPrincipalBal,#NewPrincipalBal],
["累繳金額",#OrgAccuTempAmt,#NewAccuTempAmt],["累溢收金額",#OrgAccuOverAmt,#NewAccuOverAmt],
["累應還金額",#OrgAccuDueAmt,#NewAccuDueAmt],["累新壽分攤金額",#OrgAccuSklShareAmt,#NewAccuSklShareAmt],
[#<->#,"下次應繳日",#OrgNextPayDate,#NewNextPayDate],
["償還本金",#OrgRepayPrincipal,#NewRepayPrincipal],["償還利息",#OrgRepayInterest,#NewRepayInterest],
["二階段註記",#TwoStepCode],["申請變更還款條件日",#ChgCondDate],
["戶況日期",#OrgStatusDate,#NewStatusDate],
[#<->#,"@","債務協商交易檔資料"],
["會計日期",#TransAcDate],["經辦",#TransTitaTlrNo],
[#<->#,"交易序號",#TransTitaTxtNo],
["戶號",#TransCustNo],["案件序號",#TransCaseSeq],
[#<->#,"入帳日期",#TransEntryDate],
["交易狀態",#TransTxStatus,#TransTxStatusX,#NewTransTxStatus,#NewTransTxStatusX],["交易別",#TransTxKind,#TransTxKindX,#NewTransTxKind,#NewTransTxKindX],
["交易金額",#TransTxAmt,#BtnL5971],["退還金額",#TransReturnAmt,#NewTransReturnAmt],
["新壽攤分",#TransSklShareAmt,#NewTransSklShareAmt],["撥付金額",#TransApprAmt,#NewTransApprAmt,#BtnShareAmt],
["暫收抵繳金額",#TransTempRepayAmt,#NewTransTempRepayAmt],["溢收抵繳金額",#TransOverRepayAmt,#NewTransOverRepayAmt],
["沖銷本金",#TransPrincipalAmt,#NewTransPrincipalAmt],["沖銷利息",#TransInterestAmt,#NewTransInterestAmt],
["還款金額",#SunPrincInter,#NewSunPrincInter],["轉入溢收金額",#TransOverAmt,#NewTransOverAmt],
[#<->#,"繳息起迄日",#TransIntStartDate,#NewTransIntStartDate,"-",#TransIntEndDate,#NewTransIntEndDate],
[#<->#,"還款期數",#TransRepayPeriod,#NewTransRepayPeriod],
["本次應還期數",#TransShouldPayPeriod,#NewTransShouldPayPeriod],["本次應還金額",#TransDueAmt,#NewTransDueAmt],
["尚餘期數",#RemaindPeriod,#NewRemaindPeriod],
[#<->#,"資料類別",#DataType,#DataTypeX],
]
!---------- AP TEXT AREA Variables ----------

! SunPrincInter 還款金額=TransPrincipalAmt 本金金額+TransInterestAmt 利息金額

#CHAIN=A,1,S
T(4,CHAIN$)
IF(#CHAIN==0,$,s)
V(P,本交易為連動交易，請從交易:[L5074債務協商作業－應處理事項清單]進入)

!做完交易自動更新原畫面
#AutoReFresh=A,1,S
C(3,#CHAIN,1,$,S)
E(0,1)
ASGN(CAUTO$)

![業務別] 01:撥款匯款(含暫收退還且非退票) 02:支票繳款 03:債協 09:放款
#SECNO=_,_,S
T(3,03)

#TXCDCHAIN=X,5,S
T(2,L5702)

#PreHide=X,1,S
CALL(#ShowDataNew)

#ShowDataOrg=@,1,S
HIDE(#NewRepaidPeriod,#NewPrincipalBal,#NewAccuTempAmt,#NewAccuOverAmt,#NewAccuDueAmt,#NewAccuSklShareAmt,#NewNextPayDate,#NewRepayPrincipal,#NewRepayInterest,#NewStatusDate,#NewTransTxStatus,#NewTransTxStatusX,#NewTransTxKind,#NewTransTxKindX,#NewTransReturnAmt,#NewTransSklShareAmt,#NewTransApprAmt,#NewTransTempRepayAmt,#NewTransOverRepayAmt,#NewTransPrincipalAmt,#NewTransInterestAmt,#NewSunPrincInter,#NewTransOverAmt,#NewTransIntStartDate,#NewTransIntEndDate,#NewTransRepayPeriod,#NewTransShouldPayPeriod,#NewTransDueAmt,#NewRemaindPeriod)
SHOW(#RepaidPeriod,#OrgPrincipalBal,#OrgAccuTempAmt,#OrgAccuOverAmt,#OrgAccuDueAmt,#OrgAccuSklShareAmt,#OrgNextPayDate,#OrgRepayPrincipal,#OrgRepayInterest,#OrgStatusDate,#TransTxStatus,#TransTxStatusX,#TransTxKind,#TransTxKindX,#TransReturnAmt,#TransSklShareAmt,#TransApprAmt,#TransTempRepayAmt,#TransOverRepayAmt,#TransPrincipalAmt,#TransInterestAmt,#SunPrincInter,#TransOverAmt,#TransIntStartDate,#TransIntEndDate,#TransRepayPeriod,#TransShouldPayPeriod,#TransDueAmt,#RemaindPeriod)

#ShowDataNew=@,1,S
SHOW(#NewRepaidPeriod,#NewPrincipalBal,#NewAccuTempAmt,#NewAccuOverAmt,#NewAccuDueAmt,#NewAccuSklShareAmt,#NewNextPayDate,#NewRepayPrincipal,#NewRepayInterest,#NewStatusDate,#NewTransTxStatus,#NewTransTxStatusX,#NewTransTxKind,#NewTransTxKindX,#NewTransReturnAmt,#NewTransSklShareAmt,#NewTransApprAmt,#NewTransTempRepayAmt,#NewTransOverRepayAmt,#NewTransPrincipalAmt,#NewTransInterestAmt,#NewSunPrincInter,#NewTransOverAmt,#NewTransIntStartDate,#NewTransIntEndDate,#NewTransRepayPeriod,#NewTransShouldPayPeriod,#NewTransDueAmt,#NewRemaindPeriod)
HIDE(#RepaidPeriod,#OrgPrincipalBal,#OrgAccuTempAmt,#OrgAccuOverAmt,#OrgAccuDueAmt,#OrgAccuSklShareAmt,#OrgNextPayDate,#OrgRepayPrincipal,#OrgRepayInterest,#OrgStatusDate,#TransTxStatus,#TransTxStatusX,#TransTxKind,#TransTxKindX,#TransReturnAmt,#TransSklShareAmt,#TransApprAmt,#TransTempRepayAmt,#TransOverRepayAmt,#TransPrincipalAmt,#TransInterestAmt,#SunPrincInter,#TransOverAmt,#TransIntStartDate,#TransIntEndDate,#TransRepayPeriod,#TransShouldPayPeriod,#TransDueAmt,#RemaindPeriod)

<include src="HELPRIM.icf::HELPRIM.rtn"/>
! TxStatus1
#TxStatusCode=x,20,S
T(3,CdCode.NegTxStatus)
#TxStatusHelp=x,1024,S

! TxKind2
#TxKindCode=x,20,S
T(3,CdCode.NegTxKind)
#TxKindHelp=x,1024,S

! Status3
#StatusCode=x,20,S
T(3,CdCode.NegStatus)
#StatusHelp=x,1024,S

! CustLoanKind4
#CustLoanKindCode=x,20,S
T(3,CdCode.CustLoanKind)
#CustLoanKindHelp=x,1024,S

#HelpRim=X,1,S
RESET_RIM(#HelpRim,XXR99)
S(XXR99,01,#TxStatusCode,#TxKindCode,#StatusCode,#CustLoanKindCode)
R(1,XXR99)
CALL(#HelpProc)
T(2,@TxStatusHelp,#HelpDesc1)
T(2,@TxKindHelp,#HelpDesc2)
T(2,@StatusHelp,#HelpDesc3)
T(2,@CustLoanKindHelp,#HelpDesc4)

! NegMain-Key-CustNo(7),CaseSeq(3)
! 轉入L5702用的東東 NegTrans-Key-AcDate(7),TitaTlrNo(6),TitaTxtNo(8),2023/2/14增加CustNo(7)
! #OONegTransKey=X,21,O
! T(2,#OOAcctDate+#OOTitaTlrNo+#OOTitaTxtNo)

<include src="ROM.icf::L5R12.dec"/>
#NegTransKey=X,28,S
IF(#CHAIN==1,T(4,NTXBUF$),S)
T(1,@TransAcDate,#NegTransKey,1,7)
T(1,@TransTitaTlrNo,#NegTransKey,8,6)
T(1,@TransTitaTxtNo,#NegTransKey,14,8)
T(1,@TransCustNo,#NegTransKey,22,7)

! 第一次調RIM

! [調Rim相關]
! 定義Rom欄位名稱、型態、長度
<include src="ROM.icf::L5R03.dec"/>

! 宣告Rim欲傳送的欄位1
! 欄位名稱即為後端在titaVo get值時的KEY
! 要注意欄為型態跟長度
#RimAcDate=D,7,S
! 宣告Rim欲傳送的欄位2
#RimTitaTlrNo=X,6,S
! 宣告Rim欲傳送的欄位3
#RimTitaTxtNo=X,8,S
! 測試是否為一開始的 0是一開始 1是後面修改資料後的調Rim
#RimTrialFunc=X,1,S
T(2,0)
#RimTxKind=A,1,S
#RimReturnAmt=m,14,S
#RimCustNo=A,7,S


! Rim L5R03.java
! RESET_RIM() 用意參考var function  每次調RIM->RESET_RIM(#RIM_L5R03,L5R03)
! S() 為送出資料
! 參數1為此Rim的交易代號
! 參數2為將收到的值切成幾筆
! 參數3及其後皆為tita欄位
! R() 為收到的電文轉入欄位
! 參數1，為 0 時，不顯示；為 1 時，顯示。
! 參數2，交易代號，在本交易的電文區要寫TXFROM
! RESET_RIM(#RimL5R03,L5R03) !是否每次都需要重複調RIM

#RimL5r03=X,1,S
IF(#CHAIN==1,$,S)
C(4,#TransAcDate,S,$)
C(4,#TransTitaTlrNo,S,$)
C(4,#TransTitaTxtNo,S,$)
T(2,@RimAcDate,#TransAcDate)
T(2,@RimTitaTlrNo,#TransTitaTlrNo)
T(2,@RimTitaTxtNo,#TransTitaTxtNo)
T(2,@RimTrialFunc,0)
T(2,@RimCustNo,#TransCustNo)
RESET_RIM(#RimL5r03,L5R03)
S(L5R03,1,#RimAcDate,#RimTitaTlrNo,#RimTitaTxtNo,#RimTrialFunc,#RimTxKind,#RimReturnAmt,#RimCustNo)
R(1,L5R03)
T(2,@CustId,#L5r03CustId)
T(2,@CaseSeqR,#L5r03CaseSeq)
T(2,@CustNo,#L5r03CustNo)
T(2,@CustName,#L5r03CustName)
T(2,@Status,#L5r03Status)
T(2,@NewStatus,#L5r03NewStatus)
T(2,@CustLoanKind,#L5r03CustLoanKind)
E(0,@ApplDate,#L5r03ApplDate)
E(0,@MainDueAmt,#L5r03MainDueAmt)
E(0,@TotalPeriod,#L5r03TotalPeriod)
E(0,@IntRate,#L5r03IntRate)
E(0,@RepaidPeriod,#L5r03RepaidPeriod)
E(0,@NewRepaidPeriod,#L5r03NewRepaidPeriod)
T(2,@IsMainFin,#L5r03IsMainFin)
T(2,@MainFinCode,#L5r03MainFinCode)
E(0,@OrgPrincipalBal,#L5r03OrgPrincipalBal)
E(0,@NewPrincipalBal,#L5r03NewPrincipalBal)
E(0,@OrgAccuTempAmt,#L5r03OrgAccuTempAmt)
E(0,@NewAccuTempAmt,#L5r03NewAccuTempAmt)
E(0,@OrgAccuOverAmt,#L5r03OrgAccuOverAmt)
E(0,@NewAccuOverAmt,#L5r03NewAccuOverAmt)
E(0,@OrgAccuDueAmt,#L5r03OrgAccuDueAmt)
E(0,@NewAccuDueAmt,#L5r03NewAccuDueAmt)
E(0,@OrgAccuSklShareAmt,#L5r03OrgAccuSklShareAmt)
E(0,@NewAccuSklShareAmt,#L5r03NewAccuSklShareAmt)
E(0,@OrgNextPayDate,#L5r03OrgNextPayDate)
E(0,@NewNextPayDate,#L5r03NewNextPayDate)
E(0,@OrgRepayPrincipal,#L5r03OrgRepayPrincipal)
E(0,@NewRepayPrincipal,#L5r03NewRepayPrincipal)
E(0,@OrgRepayInterest,#L5r03OrgRepayInterest)
E(0,@NewRepayInterest,#L5r03NewRepayInterest)
T(2,@TwoStepCode,#L5r03TwoStepCode)
E(0,@ChgCondDate,#L5r03ChgCondDate)
E(0,@PayIntDate,#L5r03PayIntDate)
E(0,@NewPayIntDate,#L5r03NewPayIntDate)
E(0,@OrgStatusDate,#L5r03OrgStatusDate)
E(0,@NewStatusDate,#L5r03NewStatusDate)
E(0,@TransAcDate,#L5r03TransAcDate)
T(2,@TransTitaTlrNo,#L5r03TransTitaTlrNo)
T(2,@TransTitaTxtNo,#L5r03TransTitaTxtNo)
T(2,@TransCustNo,#L5r03TransCustNo)
T(2,@TransCaseSeqR,#L5r03TransCaseSeq)
E(0,@TransEntryDate,#L5r03TransEntryDate)
E(0,@TransTxStatus,#L5r03TransTxStatus)
E(0,@NewTransTxStatus,#L5r03NewTransTxStatus)
E(0,@TransTxKind,#L5r03TransTxKind)
E(0,@NewTransTxKind,#L5r03NewTransTxKind)
E(0,@TransTxAmt,#L5r03TransTxAmt)
E(0,@NewTransTxAmt,#L5r03NewTransTxAmt)
E(0,@TransPrincipalBal,#L5r03TransPrincipalBal)
E(0,@NewTransPrincipalBal,#L5r03NewTransPrincipalBal)
E(0,@TransReturnAmt,#L5r03TransReturnAmt)
E(0,@NewTransReturnAmt,#L5r03NewTransReturnAmt)
E(0,@TransSklShareAmt,#L5r03TransSklShareAmt)
E(0,@NewTransSklShareAmt,#L5r03NewTransSklShareAmt)
E(0,@TransApprAmt,#L5r03TransApprAmt)
E(0,@NewTransApprAmt,#L5r03NewTransApprAmt)
E(0,@TransExportDate,#L5r03TransExportDate)
E(0,@TransExportAcDate,#L5r03TransExportAcDate)
E(0,@TransTempRepayAmt,#L5r03TransTempRepayAmt)
E(0,@NewTransTempRepayAmt,#L5r03NewTransTempRepayAmt)
E(0,@TransOverRepayAmt,#L5r03TransOverRepayAmt)
E(0,@NewTransOverRepayAmt,#L5r03NewTransOverRepayAmt)
E(0,@TransPrincipalAmt,#L5r03TransPrincipalAmt)
E(0,@NewTransPrincipalAmt,#L5r03NewTransPrincipalAmt)
E(0,@TransInterestAmt,#L5r03TransInterestAmt)
E(0,@NewTransInterestAmt,#L5r03NewTransInterestAmt)
E(0,@TransOverAmt,#L5r03TransOverAmt)
E(0,@NewTransOverAmt,#L5r03NewTransOverAmt)
E(0,@TransIntStartDate,#L5r03TransIntStartDate)
E(0,@NewTransIntStartDate,#L5r03NewTransIntStartDate)
E(0,@TransIntEndDate,#L5r03TransIntEndDate)
E(0,@NewTransIntEndDate,#L5r03NewTransIntEndDate)
E(0,@TransRepayPeriod,#L5r03TransRepayPeriod)
E(0,@NewTransRepayPeriod,#L5r03NewTransRepayPeriod)
E(0,@TransShouldPayPeriod,#L5r03TransShouldPayPeriod)
E(0,@NewTransShouldPayPeriod,#L5r03NewTransShouldPayPeriod)
E(0,@TransDueAmt,#L5r03TransDueAmt)
E(0,@NewTransDueAmt,#L5r03NewTransDueAmt)
E(0,@TransRepayDate,#L5r03TransRepayDate)
E(0,@NewTransRepayDate,#L5r03NewTransRepayDate)
E(0,@TransOrgAccuOverAmt,#L5r03TransOrgAccuOverAmt)
E(0,@NewTransOrgAccuOverAmt,#L5r03NewTransOrgAccuOverAmt)
E(0,@TransAccuOverAmt,#L5r03TransAccuOverAmt)
E(0,@NewTransAccuOverAmt,#L5r03NewTransAccuOverAmt)
T(2,@CaseKindCode,#L5r03CaseKindCode)

T(H,@NewTransTxStatusX,#NewTransTxStatus,#TxStatusHelp)
T(H,@NewTransTxKindX,#NewTransTxKind,#TxKindHelp)
T(H,@NewStatusX,#NewStatus,#StatusHelp)
T(H,@CustLoanKindX,#CustLoanKind,#CustLoanKindHelp)

#TempTransTxKind=A,1,S
E(0,#L5r03NewTransTxKind)

#RimBankCode=X,8,S
#FunctionCode=X,2,S
T(2,#FunctionCode,05)
#RimErrFg=A,1,S

#RimL5r12A=X,1,S
T(2,@RimBankCode,#L5r03MainFinCode)
E(0,@RimErrFg,0)
RESET_RIM(#RimL5r12A,L5R12)
S(L5R12,1,#RimBankCode,#FunctionCode,#RimErrFg)
R(1,L5R12)
T(2,@MainFinCodeX,#L5r12BankItem)

#BtnL5971=X,1,S,ui:button;value:交易資料;enable:1;tabbable:0
#BtnShareAmt=X,1,S,ui:button;value:已撥付明細;enable:1;tabbable:0

! 先處理NegTrans的同戶號的第一筆,其他都顯示待處理
#cover=X,100,O

! 身分證字號
#CustId=X,10,L

! 案件序號-NegMain
#CaseSeqR=X,3,L
#CaseSeq=A,3,L    
E(0,#CaseSeqR)

! 戶號
#CustNo=X,7,L
#CustNoA=A,7,S
E(0,#CustNo)

#CustName=x,100,L

! 案件種類
#CaseKindCode=X,1,S


! 債權戶況
#Status=X,1,S
#NewStatus=X,1,S
#StatusX=X,6,L
T(H,#Status,#StatusHelp)
#NewStatusX=X,6,L
T(H,#NewStatus,#StatusHelp)

! 債權戶別
#CustLoanKind=X,1,S
#CustLoanKindX=X,6,L
T(H,#CustLoanKind,#CustLoanKindHelp)
! 協商申請日
#ApplDate=D,7,L

! 每期期款
#MainDueAmt=m,14,L

! 期數
#TotalPeriod=A,3,L

! 每期利率
#IntRate=m,2.2,L

! 已繳期數
#RepaidPeriod=A,3,L
#NewRepaidPeriod=A,3,L
! 最大債權
#IsMainFin=X,1,L

! 最大債權機構
!#MainFinCode=A,3,L
#MainFinCode=X,8,L
@T(3,@MainFinCodeX,)

#RimL5r12B=X,1,S
T(2,@RimBankCode,#MainFinCode)
E(0,@RimErrFg,0)
RESET_RIM(#RimL5r12B,L5R12)
S(L5R12,1,#RimBankCode,#FunctionCode,#RimErrFg)
R(1,L5R12)
T(2,@MainFinCodeX,#L5r12BankItem)

#MainFinCodeX=X,100,L

! Org總本金餘額
#OrgPrincipalBal=m,14,L
#NewPrincipalBal=m,14,L
! Org累暫收金額
#OrgAccuTempAmt=m,14,L
#NewAccuTempAmt=m,14,L
! Org累溢收金額
#OrgAccuOverAmt=m,14,L
#NewAccuOverAmt=m,14,L
! Org累期款金額
#OrgAccuDueAmt=m,14,L
#NewAccuDueAmt=m,14,L
! Org累新壽分攤金額
#OrgAccuSklShareAmt=m,14,L
#NewAccuSklShareAmt=m,14,L
! Org下次應繳日
#OrgNextPayDate=D,7,L
#NewNextPayDate=D,7,L
! Org還本本金
#OrgRepayPrincipal=m,14,L
#NewRepayPrincipal=m,14,L
! Org還本利息
#OrgRepayInterest=+m,14,L
#NewRepayInterest=+m,14,L
! Org二階段註記
#TwoStepCode=X,1,L
! 申請變更還款條件日
#ChgCondDate=D,7,L
! 繳息迄日
#PayIntDate=D,7,L
#NewPayIntDate=D,7,L
! 戶況日期
#OrgStatusDate=D,7,L
#NewStatusDate=D,7,L

!-----NegTrans---
! 會計日期
#TransAcDate=D,7,L

! 經辦
#TransTitaTlrNo=X,6,L

! 交易序號
#TransTitaTxtNo=X,8,L

! 戶號
#TransCustNo=X,7,L

! 案件序號-NegMain
#TransCaseSeqR=X,3,L
#TransCaseSeq=A,3,L  
E(0,#TransCaseSeqR)

! 入帳日期
#TransEntryDate=D,7,L
! 交易狀態
#TransTxStatus=A,1,L

#TransTxStatusX=X,8,L
!T(H,#TransTxStatus,#TxStatusHelp)

#NewTransTxStatus=A,1,L

#NewTransTxStatusX=X,8,L
!T(H,#NewTransTxStatus,#TxStatusHelp)

! 交易別
#TransTxKind=A,1,L

#TransTxKindX=X,8,L
!T(H,#TransTxKind,#TxKindHelp)

#NewTransTxKind=A,1,I
HELP(#TxKindHelp,cols:3)
@T(3,@NewTransTxKindX,)
V(H,#TxKindHelp)
@IF(#NewTransTxKind==9,V(P,請勿輸入9),$)
@IF(#NewTransTxKind==6,s,$)

#NewTransTxKindX=X,8,L
T(H,#NewTransTxKind,#TxKindHelp)
!案件種類是更生時,且金額>=期款,才可讓使用者選擇要還1期或提前還本
#CheckTxKindX=X,1,S
@IF(#NewTransTxKind==6,s,$)
IF(#CaseKindCode==3,IF(#L5r03NewTransTxKind==0 || #L5r03NewTransTxKind==1 || #L5r03NewTransTxKind==3,IF(#NewTransTxKind==3,s,$),$),$)
IF(#L5r03NewTransTxKind==3,IF(#NewTransTxKind==1 || #NewTransTxKind==3,s,$),IF(#TempTransTxKind!=#NewTransTxKind,$,s))
IF(#CaseKindCode==3,V(P,更生僅金額大於等於期款可換成提前還本，其餘不可變更),V(P,僅提前還本可換成溢繳，其餘不可變更))

! 暫收金額-NegTrans
#TransTxAmt=m,14,L
#NewTransTxAmt=m,14,L

! <交易資料>
#BufChainSearch=X,22,S
T(2,05+#CustId+#CustNo+#CaseSeq)

#BindL5971=X,1,S
BIND(#BtnL5971,click, {cmd=CHAIN; ntxcd=L5971; ntxbuf=#BufChainSearch})

! 本金餘額
#TransPrincipalBal=m,14,L
#NewTransPrincipalBal=m,14,L
! 退還金額
#TransReturnAmt=m,14,L
#NewTransReturnAmt=m,14,L

! 調RIM 修改 交易別後重新計算
#ChangeReturnAmtRimL5r03=X,1,S
IF(#CHAIN==1,$,S)
C(4,#TransAcDate,S,$)
C(4,#TransTitaTlrNo,S,$)
C(4,#TransTitaTxtNo,S,$)
T(2,@RimAcDate,#TransAcDate)
T(2,@RimTitaTlrNo,#TransTitaTlrNo)
T(2,@RimTitaTxtNo,#TransTitaTxtNo)
T(2,@RimTxKind,#NewTransTxKind)
T(2,@RimReturnAmt,#NewTransReturnAmt)
T(2,@RimTrialFunc,1)
T(2,@RimCustNo,#TransCustNo)
RESET_RIM(#RimL5r03,L5R03)
S(L5R03,1,#RimAcDate,#RimTitaTlrNo,#RimTitaTxtNo,#RimTrialFunc,#RimTxKind,#RimReturnAmt,#RimCustNo)
R(1,L5R03)
T(2,@CustId,#L5r03CustId)
T(2,@CaseSeqR,#L5r03CaseSeq)
T(2,@CustNo,#L5r03CustNo)
T(2,@CustName,#L5r03CustName)
T(2,@Status,#L5r03Status)
T(2,@NewStatus,#L5r03NewStatus)
T(2,@CustLoanKind,#L5r03CustLoanKind)
E(0,@ApplDate,#L5r03ApplDate)
E(0,@MainDueAmt,#L5r03MainDueAmt)
E(0,@TotalPeriod,#L5r03TotalPeriod)
E(0,@IntRate,#L5r03IntRate)
E(0,@RepaidPeriod,#L5r03RepaidPeriod)
E(0,@NewRepaidPeriod,#L5r03NewRepaidPeriod)
T(2,@IsMainFin,#L5r03IsMainFin)
T(2,@MainFinCode,#L5r03MainFinCode)
E(0,@OrgPrincipalBal,#L5r03OrgPrincipalBal)
E(0,@NewPrincipalBal,#L5r03NewPrincipalBal)
E(0,@OrgAccuTempAmt,#L5r03OrgAccuTempAmt)
E(0,@NewAccuTempAmt,#L5r03NewAccuTempAmt)
E(0,@OrgAccuOverAmt,#L5r03OrgAccuOverAmt)
E(0,@NewAccuOverAmt,#L5r03NewAccuOverAmt)
E(0,@OrgAccuDueAmt,#L5r03OrgAccuDueAmt)
E(0,@NewAccuDueAmt,#L5r03NewAccuDueAmt)
E(0,@OrgAccuSklShareAmt,#L5r03OrgAccuSklShareAmt)
E(0,@NewAccuSklShareAmt,#L5r03NewAccuSklShareAmt)
E(0,@OrgNextPayDate,#L5r03OrgNextPayDate)
E(0,@NewNextPayDate,#L5r03NewNextPayDate)
E(0,@OrgRepayPrincipal,#L5r03OrgRepayPrincipal)
E(0,@NewRepayPrincipal,#L5r03NewRepayPrincipal)
E(0,@OrgRepayInterest,#L5r03OrgRepayInterest)
E(0,@NewRepayInterest,#L5r03NewRepayInterest)
T(2,@TwoStepCode,#L5r03TwoStepCode)
E(0,@ChgCondDate,#L5r03ChgCondDate)
E(0,@PayIntDate,#L5r03PayIntDate)
E(0,@NewPayIntDate,#L5r03NewPayIntDate)
E(0,@OrgStatusDate,#L5r03OrgStatusDate)
E(0,@NewStatusDate,#L5r03NewStatusDate)
E(0,@TransAcDate,#L5r03TransAcDate)
T(2,@TransTitaTlrNo,#L5r03TransTitaTlrNo)
T(2,@TransTitaTxtNo,#L5r03TransTitaTxtNo)
T(2,@TransCustNo,#L5r03TransCustNo)
T(2,@TransCaseSeqR,#L5r03TransCaseSeq)
E(0,@TransEntryDate,#L5r03TransEntryDate)
E(0,@TransTxStatus,#L5r03TransTxStatus)
E(0,@NewTransTxStatus,#L5r03NewTransTxStatus)
E(0,@TransTxKind,#L5r03TransTxKind)
E(0,@NewTransTxKind,#L5r03NewTransTxKind)
E(0,@TransTxAmt,#L5r03TransTxAmt)
E(0,@NewTransTxAmt,#L5r03NewTransTxAmt)
E(0,@TransPrincipalBal,#L5r03TransPrincipalBal)
E(0,@NewTransPrincipalBal,#L5r03NewTransPrincipalBal)
E(0,@TransReturnAmt,#L5r03TransReturnAmt)
E(0,@NewTransReturnAmt,#L5r03NewTransReturnAmt)
E(0,@TransSklShareAmt,#L5r03TransSklShareAmt)
E(0,@NewTransSklShareAmt,#L5r03NewTransSklShareAmt)
E(0,@TransApprAmt,#L5r03TransApprAmt)
E(0,@NewTransApprAmt,#L5r03NewTransApprAmt)
E(0,@TransExportDate,#L5r03TransExportDate)
E(0,@TransExportAcDate,#L5r03TransExportAcDate)
E(0,@TransTempRepayAmt,#L5r03TransTempRepayAmt)
E(0,@NewTransTempRepayAmt,#L5r03NewTransTempRepayAmt)
E(0,@TransOverRepayAmt,#L5r03TransOverRepayAmt)
E(0,@NewTransOverRepayAmt,#L5r03NewTransOverRepayAmt)
E(0,@TransPrincipalAmt,#L5r03TransPrincipalAmt)
E(0,@NewTransPrincipalAmt,#L5r03NewTransPrincipalAmt)
E(0,@TransInterestAmt,#L5r03TransInterestAmt)
E(0,@NewTransInterestAmt,#L5r03NewTransInterestAmt)
E(0,@TransOverAmt,#L5r03TransOverAmt)
E(0,@NewTransOverAmt,#L5r03NewTransOverAmt)
E(0,@TransIntStartDate,#L5r03TransIntStartDate)
E(0,@NewTransIntStartDate,#L5r03NewTransIntStartDate)
E(0,@TransIntEndDate,#L5r03TransIntEndDate)
E(0,@NewTransIntEndDate,#L5r03NewTransIntEndDate)
E(0,@TransRepayPeriod,#L5r03TransRepayPeriod)
E(0,@NewTransRepayPeriod,#L5r03NewTransRepayPeriod)
E(0,@TransShouldPayPeriod,#L5r03TransShouldPayPeriod)
E(0,@NewTransShouldPayPeriod,#L5r03NewTransShouldPayPeriod)
E(0,@TransDueAmt,#L5r03TransDueAmt)
E(0,@NewTransDueAmt,#L5r03NewTransDueAmt)
E(0,@TransRepayDate,#L5r03TransRepayDate)
E(0,@NewTransRepayDate,#L5r03NewTransRepayDate)
E(0,@TransOrgAccuOverAmt,#L5r03TransOrgAccuOverAmt)
E(0,@NewTransOrgAccuOverAmt,#L5r03NewTransOrgAccuOverAmt)
E(0,@TransAccuOverAmt,#L5r03TransAccuOverAmt)
E(0,@NewTransAccuOverAmt,#L5r03NewTransAccuOverAmt)
T(2,@CaseKindCode,#L5r03CaseKindCode)

T(H,@NewTransTxStatusX,#NewTransTxStatus,#TxStatusHelp)
T(H,@NewTransTxKindX,#NewTransTxKind,#TxKindHelp)
T(H,@NewStatusX,#NewStatus,#StatusHelp)
T(H,@CustLoanKindX,#CustLoanKind,#CustLoanKindHelp)

#RimL5r12C=X,1,S
T(2,@RimBankCode,#MainFinCode)
E(0,@RimErrFg,0)
RESET_RIM(#RimL5r12C,L5R12)
S(L5R12,1,#RimBankCode,#FunctionCode,#RimErrFg)
R(1,L5R12)
T(2,@MainFinCodeX,#L5r12BankItem)

! 攤分金額
#TransSklShareAmt=m,14,L
#NewTransSklShareAmt=m,14,L


! 撥付金額
#TransApprAmt=m,14,L
#NewTransApprAmt=m,14,L

! 撥付製檔日
#TransExportDate=D,7,L

! <已撥付明細>
#BufL5973=X,17,S
T(2,#TransExportDate+#CustId)

#BindExportDate=X,1,S
BIND(#BtnShareAmt,click, {cmd=CHAIN; ntxcd=L5973; ntxbuf=#BufL5973})


! 撥付出帳日
#TransExportAcDate=D,7,L

! 暫收抵繳金額
#TransTempRepayAmt=m,14,L
#NewTransTempRepayAmt=m,14,L

! 溢收抵繳金額=期金(NegMain-DueAmt)-交易金額(NegTrans-TxAmt)
#TransOverRepayAmt=m,14,L
#NewTransOverRepayAmt=m,14,L
! 沖銷本金
#TransPrincipalAmt=m,14,L
#NewTransPrincipalAmt=m,14,L
! 沖銷利息
#TransInterestAmt=+m,14,L
#NewTransInterestAmt=+m,14,L
! 還款金額=TransPrincipalAmt+TransInterestAmt
#SunPrincInter=m,14,L
E(0,#TransPrincipalAmt+#TransInterestAmt)
#NewSunPrincInter=m,14,L
E(0,#NewTransPrincipalAmt+#NewTransInterestAmt)
! 轉入溢收金額
#TransOverAmt=m,14,L
#NewTransOverAmt=m,14,L
! 繳息起日
#TransIntStartDate=D,7,L
#NewTransIntStartDate=D,7,L
! 繳息訖日
#TransIntEndDate=D,7,L
#NewTransIntEndDate=D,7,L

! 還款期數
#TransRepayPeriod=A,3,L
#NewTransRepayPeriod=A,3,L

! 本次應還期數-NegTrans
#TransShouldPayPeriod=A,3,L
#NewTransShouldPayPeriod=A,3,L
! 本次應還金額-NegTrans
#TransDueAmt=m,14,L
#NewTransDueAmt=m,14,L
! 入帳還款日期
#TransRepayDate=D,7,L
#NewTransRepayDate=D,7,L
! 累溢繳款(交易前)
#TransOrgAccuOverAmt=m,14,L
#NewTransOrgAccuOverAmt=m,14,L
! 累溢繳款(交易後)
#TransAccuOverAmt=m,14,L
#NewTransAccuOverAmt=m,14,L
! 尚餘期數
#RemaindPeriod=A,3,L
E(0,#TotalPeriod-#RepaidPeriod)

#NewRemaindPeriod=A,3,L
IF(#NewTransTxKind==6,E(0,#RemaindPeriod),$)
IF(#TotalPeriod-#NewRepaidPeriod<0,E(0,0),IF(#NewTransTxKind==4 || #NewTransTxKind==5,E(0,0),E(0,#TotalPeriod-#NewRepaidPeriod)))


! 程式內部需用 0:一開始試算 1:異動後 試算 2:UPDATE 3:多筆
#TrialFunc=A,1,L
E(0,2)

#DataTypeValue=X,23,S
T(3,0:異動前;1:異動後)
T(2,@DataType,1)

!DataType=0異動前 時不顯示確定按鈕
#DataType=X,1,I
IF(#TrialFunc==2,$,S)
HELP(#DataTypeValue)
@T(3,@DataTypeX,)
V(H,#DataTypeValue)
IF(#DataType==0,CALL(#ShowDataOrg),CALL(#ShowDataNew))
IF(#DataType==0,K(NOBUTTON,CLOSEY),K(NOBUTTON,SHOWY))

#DataTypeX=X,12,L
T(H,#DataType,#DataTypeValue)



!訂正時顯示之欄位
!參考編號
#MRKEY=_,_,S
T(2,#CustNoA+#CaseSeq)
![交易金額]
#TXAMT=_,_,S
E(0,#TransTxAmt)

#RPTFG=A,1,S
E(0,0)



</sub>

!---------- 輸出共用變數宣告區 ----------
<sub type="RTN" name="AFXMT">
<include src="PRT.icf::PRTHEAD.rtn"/>
<include src="PRT.icf::FM101.rtn"/>
</sub>

!------------ TXFORM = L5702 -----------
<sub type="FORM" name="L5702">
</sub>
!---------- TXFORM = FM101 交易分錄----------
<sub type="FORM" name="FM101">
<include src="PRT.icf::FM101.form"/>
</sub>
!------ 上行電文 TEXT ------
!-----因為安全性的問題,上交易後要記得重新計算
<sub type="TIM">
#CustId
#CaseSeq
#CustNo
#Status
#NewStatus
#CustLoanKind
#ApplDate
#MainDueAmt
#TotalPeriod
#IntRate
#RepaidPeriod
#NewRepaidPeriod
#IsMainFin
#MainFinCode
#OrgPrincipalBal
#NewPrincipalBal
#OrgAccuTempAmt
#NewAccuTempAmt
#OrgAccuOverAmt
#NewAccuOverAmt
#OrgAccuDueAmt
#NewAccuDueAmt
#OrgAccuSklShareAmt
#NewAccuSklShareAmt
#OrgNextPayDate
#NewNextPayDate
#OrgRepayPrincipal
#NewRepayPrincipal
#OrgRepayInterest
#NewRepayInterest
#TwoStepCode
#ChgCondDate
#PayIntDate
#NewPayIntDate
#OrgStatusDate
#NewStatusDate
#TransAcDate
#TransTitaTlrNo
#TransTitaTxtNo
#TransCustNo
#TransCaseSeq
#TransEntryDate
#TransTxStatus
#NewTransTxStatus
#TransTxKind
#NewTransTxKind
#TransTxAmt
#NewTransTxAmt
#TransPrincipalBal
#NewTransPrincipalBal
#TransReturnAmt
#NewTransReturnAmt
#TransSklShareAmt
#NewTransSklShareAmt
#TransApprAmt
#NewTransApprAmt
#TransExportDate
#TransExportAcDate
#TransTempRepayAmt
#NewTransTempRepayAmt
#TransOverRepayAmt
#NewTransOverRepayAmt
#TransPrincipalAmt
#NewTransPrincipalAmt
#TransInterestAmt
#NewTransInterestAmt
#TransOverAmt
#NewTransOverAmt
#TransIntStartDate
#NewTransIntStartDate
#TransIntEndDate
#NewTransIntEndDate
#TransRepayPeriod
#NewTransRepayPeriod
#TransShouldPayPeriod
#NewTransShouldPayPeriod
#TransDueAmt
#NewTransDueAmt
#TransRepayDate
#NewTransRepayDate
#TransOrgAccuOverAmt
#NewTransOrgAccuOverAmt
#TransAccuOverAmt
#NewTransAccuOverAmt
#TrialFunc
#TXCDCHAIN
</sub>

!------ 下行電文TOM ------
<sub type="TOM">
<include src="COM.icf::TRCTL.tom"/>
<include src="ROM.icf::L5R03.tom"/>
<include src="ROM.icf::L5R12.tom"/>
<include src="PRT.icf::FM101.tom"/>
<include src="HELPRIM.icf::HELPRIM.tom"/>
TXFORM=L5702
^
</sub>

!---------- 單據輸出組合 ----------
<sub type="SELECT">
<include src="PRT.icf::UPD01.sel"/>
<include src="PRT.icf::FM101.sel" map="landscape=1;size=830:1170" />
<include src="PRT.icf::UPDH01.sel"/>
<include src="PRT.icf::FM01.sel"/>
<include src="PRT.icf::FMR01.sel"/>
<include src="PRT.icf::FMH01.sel"/>
<include src="PRT.icf::FMHR01.sel"/>

</sub>